<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Fields | Critical Fields</title> <link rel="stylesheet" href="styles.css" />
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono&display=swap" rel="stylesheet">
  <style>
    /* Minimal inline styles to complement styles.css for the Fields page */
    body {
        font-family: 'IBM Plex Mono', monospace;
        background-color: var(--color-main-bg);
        color: var(--color-text-primary);
        margin: 0;
        padding: 0;
        line-height: 1.7;
        letter-spacing: -0.01em;
        overflow-x: hidden;
        position: relative;
    }
    main {
        padding: 2rem;
        max-width: 1200px;
        margin: 0 auto;
        /* Main is now a standard block container, not a flex container */
    }

    /* REMOVED: .top-content-row and .column-half styles */

    /* Hero Section (Compressed Further) */
    .field-hero {
        text-align: center;
        padding: 0.5rem 1.5rem; /* Adjusted: Even smaller padding for less height */
        background: var(--color-secondary-bg); /* Use secondary background for hero */
        color: var(--color-text-primary);
        border-bottom: 1px solid var(--color-border-dark);
        box-shadow: var(--shadow-element); /* Add a subtle shadow */
        border-radius: 4px;
        border: 1px solid var(--color-border-dark);
        margin-bottom: 2rem; /* Adjusted: Less margin below hero */
    }
    .field-hero h2 {
        font-size: 2rem; /* Adjusted: Smaller hero title */
        margin-bottom: 1.5rem; /* Adjusted: Less margin below title */
        text-transform: lowercase;
        color: var(--color-accent-highlight); /* Red for hero title */
        text-shadow: 0 0 8px rgba(255, 65, 54, 0.5);
    }
    .field-hero p {
        font-size: 0.95rem; /* Adjusted: Smaller description */
        max-width: 500px; /* Adjusted: Even narrower for tighter layout */
        margin: 0 auto;
        line-height: 1.5;
        color: var(--color-text-secondary);
    }
    .field-section-title {
        text-align: center;
        font-size: 2rem;
        margin-top: 0.5 rem; /* Standard section title margin */
        margin-bottom: 2.5rem;
        color: var(--color-accent-highlight); /* Red for section titles */
        border-bottom: 1px solid var(--color-border-dark);
        padding-bottom: 0.5rem;
        display: block;
        max-width: fit-content;
        text-transform: uppercase;
        letter-spacing: 1px;
        margin-left: auto;
        margin-right: auto;
    }
    .content-area {
        margin-bottom: 3rem; /* Standard spacing between major content blocks */
    }
    .content-grid { /* Used for Editor's Selections and Weekly Briefing (now simple lists too) */
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 1.5rem;
    }
    .feature-card { /* Used for Editor's Selections and Weekly Briefing */
        background: var(--color-card-bg);
        border: 1px solid var(--color-border-dark);
        border-radius: 4px;
        box-shadow: var(--shadow-outset-top), var(--shadow-outset-bottom),
                    4px 4px 0px var(--color-border-dark);
        overflow: hidden;
        text-decoration: none;
        color: inherit;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
        display: flex;
        flex-direction: column;
        height: 100%;
    }
    .feature-card:hover {
        transform: translateY(-3px);
        box-shadow: var(--shadow-outset-top), var(--shadow-outset-bottom),
                    6px 6px 0px rgba(0,0,0,0.4);
    }
    .feature-card-content {
        padding: 1rem;
        flex-grow: 1;
        display: flex;
        flex-direction: column;
    }
    .feature-card-content h4 {
        margin: 0 0 0.5rem;
        font-size: 1.05rem;
        color: var(--color-accent-highlight);
        line-height: 1.4;
    }
    .feature-card-content p {
        font-size: 0.85rem;
        color: var(--color-text-secondary);
        line-height: 1.5;
        margin-bottom: 0.75rem;
        flex-grow: 1;
    }
    .feature-card-meta {
        font-size: 0.75rem;
        color: var(--color-text-secondary);
        margin-top: auto;
        text-align: right;
        opacity: 0.8;
    }
    .loading-message {
        text-align: center;
        padding: 1.5rem;
        font-size: 1rem;
        color: var(--color-text-secondary);
        grid-column: 1 / -1;
        font-style: italic;
        border: 1px dashed var(--color-border-dark);
        border-radius: 4px;
        background-color: var(--color-secondary-bg);
    }
    .error-message {
        color: var(--color-ui-red);
    }

    .coming-soon {
        text-align: center;
        padding: 2rem;
        font-style: italic;
        color: var(--color-text-secondary);
        font-size: 1.1rem;
        grid-column: 1 / -1;
        border: 1px dashed var(--color-border-dark);
        border-radius: 4px;
        background-color: var(--color-secondary-bg);
    }

    /* --- NEW: Vertical Article List Styles (Native Scroll, No Images) --- */
    #rss-vertical-list-section { /* Main container for the RSS list */
        background-color: var(--color-card-bg); /* Outer box for the entire feed section */
        padding: 2rem;
        border-radius: 8px;
        border: 1px solid var(--color-border-dark);
        box-shadow: var(--shadow-outset-top), var(--shadow-outset-bottom), 4px 4px 0px var(--color-border-dark);
        text-align: center;
    }

    .vertical-articles-list-wrapper { /* This is the scrollable container */
        max-width: 800px; /* Constrain content width */
        width: 100%;
        height: 270px; /* Fixed height to display 3 articles (approx 90px per article + gaps) */
        overflow-y: scroll; /* Allow native vertical scrolling */
        -webkit-overflow-scrolling: touch; /* Smooth scrolling on iOS */
        scrollbar-width: thin; /* Firefox */
        scrollbar-color: var(--color-accent-highlight) var(--color-secondary-bg); /* Firefox */

        border: 1px solid var(--color-border-dark); /* Inner frame for the content window */
        border-radius: 4px;
        background-color: var(--color-secondary-bg);
        box-shadow: inset 1px 1px 0px var(--color-border-dark), inset -1px -1px 0px var(--color-border-light);
        margin: 0 auto; /* Center the content wrapper within its parent */
        padding: 10px; /* Inner padding for the list */
        box-sizing: border-box;
    }
    /* Styles for the scrollbar itself (Webkit browsers like Chrome/Safari) */
    .vertical-articles-list-wrapper::-webkit-scrollbar {
        width: 8px;
    }
    .vertical-articles-list-wrapper::-webkit-scrollbar-track {
        background: var(--color-secondary-bg);
        border-radius: 10px;
    }
    .vertical-articles-list-wrapper::-webkit-scrollbar-thumb {
        background: var(--color-accent-highlight);
        border-radius: 10px;
        border: 2px solid var(--color-secondary-bg); /* Padding around thumb */
    }
    .vertical-articles-list-wrapper::-webkit-scrollbar-thumb:hover {
        background: var(--color-ui-red-light);
    }

    .vertical-articles-list { /* This is the <ol> element now */
        list-style: decimal; /* Add numbering */
        padding-left: 25px; /* Space for numbers */
        margin: 0; /* Remove default margin */
        display: flex;
        flex-direction: column; /* Stack articles vertically */
        width: 100%;
        height: auto; 
    }

    .vertical-article-item { /* Styles for each <li> in the list */
        display: flex; 
        align-items: center; /* Vertically center content */
        gap: 10px; 
        padding: 8px 0; 
        border-bottom: 1px dashed var(--color-border-dark);
        text-align: left; 
        min-height: 80px; /* Consistent height for each item in the list */
    }

    .vertical-article-item:last-child {
        border-bottom: none; 
    }

    /* REMOVED: Image container and thumbnail styles */
    /* .article-thumb-container, .article-thumb-container.placeholder-thumb, .article-thumb */

    .article-text-content {
        flex-grow: 1; /* Allows text to take remaining space */
    }

    .article-title-small {
        font-size: 0.95rem; 
        margin: 0 0 2px;
        line-height: 1.3;
    }
    .article-title-small a {
        color: var(--color-text-primary);
        text-decoration: none;
        font-weight: 600;
    }
    .article-title-small a:hover {
        color: var(--color-accent-highlight);
        text-decoration: underline;
    }

    .article-meta-small {
        font-size: 0.75rem; 
        color: var(--color-text-secondary);
        opacity: 0.8;
        margin: 0;
    }

    /* --- NEW: Simple List Styling for Foundational Resources --- */
    .basic-numbered-list {
        list-style: decimal; /* Add numbering */
        padding-left: 25px; /* Space for numbers */
        margin: 0 auto; /* Center list */
        max-width: 800px; /* Constrain width */
        background-color: var(--color-secondary-bg);
        border: 1px solid var(--color-border-dark);
        border-radius: 4px;
        box-shadow: inset 1px 1px 0px var(--color-border-dark), inset -1px -1px 0px var(--color-border-light);
        padding: 1.5rem 25px 1.5rem; /* Padding + left space for numbers */
        text-align: left;
    }
    .basic-numbered-list li {
        margin-bottom: 0.8rem;
        font-size: 1rem;
        color: var(--color-text-primary);
        border-bottom: 1px dashed var(--color-border-dark);
        padding-bottom: 0.8rem;
        line-height: 1.6;
    }
    .basic-numbered-list li:last-child {
        border-bottom: none;
        margin-bottom: 0;
        padding-bottom: 0;
    }
    .basic-numbered-list li a {
        color: var(--color-text-primary);
        text-decoration: none;
        font-weight: 600;
    }
    .basic-numbered-list li a:hover {
        color: var(--color-accent-highlight);
        text-decoration: underline;
    }
    .basic-numbered-list li .item-meta {
        font-size: 0.85rem;
        color: var(--color-text-secondary);
        opacity: 0.8;
        display: block;
        margin-top: 0.2rem;
    }

    /* --- Field Index Page Styles (Digital Card Catalog Style) --- */
    #field-index-wrapper {
        background-color: var(--color-card-bg);
        border: 1px solid var(--color-border-dark);
        border-radius: 4px;
        box-shadow: var(--shadow-outset-top), var(--shadow-outset-bottom),
                    4px 4px 0px var(--color-border-dark);
        padding: 2rem;
        max-width: 1000px;
        margin: 3rem auto;
        text-align: center; /* Center the grid within the wrapper */
    }

    #field-catalog-container {
        display: grid; 
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); /* Responsive grid for cards */
        gap: 1.5rem;
        padding: 1rem 0;
        justify-content: center;
        text-align: left; /* Align content of items */
    }

    .field-catalog-item {
        background-color: var(--color-secondary-bg);
        border: 1px solid var(--color-border-dark);
        border-radius: 4px;
        box-shadow: var(--shadow-outset-top), var(--shadow-outset-bottom),
                    2px 2px 0px var(--color-border-dark);
        padding: 1.5rem;
        text-decoration: none;
        color: inherit;
        transition: all 0.2s ease;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        align-items: flex-start; /* Align text content left */
        text-align: left; /* Ensure content is left-aligned */
    }

    .field-catalog-item:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-outset-top), var(--shadow-outset-bottom),
                    4px 4px 0px rgba(0,0,0,0.4);
        background-color: var(--color-card-bg);
        border-color: var(--color-ui-red);
    }

    .field-catalog-item .catalog-title {
        font-size: 1.25rem;
        font-weight: bold;
        color: var(--color-accent-highlight);
        text-transform: uppercase;
        margin-bottom: 0.8rem;
        line-height: 1.2;
    }

    .field-catalog-item .catalog-description {
        font-size: 0.9rem;
        color: var(--color-text-secondary);
        line-height: 1.6;
        margin-bottom: 1rem;
        flex-grow: 1;
    }

    .field-catalog-item .cta-link {
        display: inline-block;
        font-size: 0.9rem;
        font-weight: 600;
        color: var(--color-ui-red);
        text-decoration: underline;
        text-transform: lowercase;
        margin-top: auto;
    }
    .field-catalog-item .cta-link:hover {
        color: var(--color-ui-red-light);
    }


    /* Responsive adjustments */
    @media (max-width: 900px) { /* Adjust breakpoint for two-column layout */
        .top-content-row {
            flex-direction: column; /* Stack columns on smaller screens */
            gap: 2rem; /* Gap between stacked columns */
        }
        .column-half { /* Applied to elements inside .top-content-row */
            min-width: unset; /* Remove min-width */
            width: 100%; /* Take full width */
        }
        .field-hero {
            margin-bottom: 0; /* No margin when stacked */
        }
        #rss-vertical-list-section {
            margin-bottom: 0; /* No margin when stacked */
        }
    }

    @media (max-width: 768px) {
        main {
            padding: 1rem;
            gap: 1.5rem; /* Smaller gap on mobile for main sections */
        }
        .field-hero {
            padding: 1rem; /* Smaller padding on mobile */
        }
        .field-hero h2 {
            font-size: 1.8rem; /* Smaller hero title on mobile */
        }
        .field-hero p {
            font-size: 0.9rem; /* Smaller hero description on mobile */
        }
        .field-section-title {
            font-size: 1.5rem;
            margin-top: 2rem;
            margin-bottom: 1.5rem;
        }
        .content-grid { /* For Editor's Selections/Weekly Briefing */
            grid-template-columns: 1fr;
            gap: 1rem;
        }
        /* Vertical List Responsive */
        #rss-vertical-list-section {
            padding: 1.5rem;
        }
        .vertical-articles-list-wrapper {
            height: 240px; /* Adjusted height for 3 articles on mobile (80px per article) */
            padding: 8px;
        }
        .vertical-article-item { /* Renamed to vertical-article-item */
            min-height: auto;
            padding: 8px 0;
        }
        .article-title-small {
            font-size: 0.9em;
        }
        .article-meta-small {
            font-size: 0.7em;
        }
        /* Field Index Page Responsive */
        #field-index-wrapper {
            padding: 1.5rem;
            margin: 2rem auto;
        }
        #field-catalog-container {
            grid-template-columns: 1fr; /* Single column for field index on mobile */
            padding: 1rem;
        }
        .field-catalog-item {
            padding: 1rem;
        }
        .field-catalog-item .catalog-title {
            font-size: 1.1rem;
        }
        .field-catalog-item .catalog-description {
            font-size: 0.85rem;
        }
    }
  </style>
</head>
<body>
  <header class="site-header">
    <nav class="navbar">
      <h1 class="logo">Critical Fields</h1>
      <ul class="nav-menu">
        <li><a href="index.html">Home</a></li>
        <li class="dropdown">
          <a href="fields.html">Fields</a>
          <ul class="dropdown-menu">
            <li><a href="fields.html?name=heterodox-economics">Heterodox Economics</a></li>
            <li><a href="fields.html?name=architectures-of-power">Architectures of Power</a></li>
            <li><a href="fields.html?name=the-digital-apparatus">The Digital Apparatus</a></li>
            <li><a href="fields.html?name=earth-systems">Earth Systems</a></li>
            <li><a href="fields.html?name=the-social-commons">The Social Commons</a></li>
            <li><a href="fields.html?name=critical-methodologies">Critical Methodologies</a></li>
            </ul>
        </li>
        <li><a href="resources.html">Archive</a></li>
        <li><a href="network.html">Network</a></li>
        <li><a href="about.html">About</a></li>
      </ul>
    </nav>
  </header>

  <main id="main-content-area">
    </main>

  <footer class="site-footer">
    <p>&copy; 2025 Critical Fields.</p>
  </footer>

 <script>
    // --- Configuration for Field Page Dynamic Content ---
    // Your comprehensive Archive Sheet URL (used for all content pulling from your sheet)
    const GOOGLE_SHEET_COMPREHENSIVE_ARCHIVE_URL = 'https://docs.google.com/sheets/d/e/2PACX-1vSdn5xz0N63Dzl0n7PRGNTBLk5RkcddzJQ4MoObZJFNeE-9qUbYkdO49bgGlwUyJnby0innAVYaVR7n/pub?output=csv';

    // *** NEW: Your Backend API URL ***
    // When deployed, this will change to your actual deployed backend URL
    const BACKEND_RSS_API_URL = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
                            ? 'http://localhost:3000/api/field-rss' // Local backend address
                            : 'https://critical-fields-site.onrender.com/api/field-rss'; // Deployed Render backend address

    // Map of field names (from URL param) to their display titles and descriptions
    const fieldData = {
        'heterodox-economics': {
            title: 'Heterodox Economics',
            description: 'Challenging mainstream economic theories with diverse perspectives on markets, society, and power structures.',
        },
        'architectures-of-power': {
            title: 'Architectures of Power',
            description: 'Investigating the unseen structures and systems that shape societal control, governance, and influence.',
        },
        'the-digital-apparatus': {
            title: 'The Digital Apparatus',
            description: 'Examining the political, social, and cultural impacts of digital technologies, AI, and information networks.',
        },
        'earth-systems': {
            title: 'Earth Systems',
            description: 'Exploring the intricate relationships between human societies and planetary ecologies, climate, and environmental justice.',
        },
        'the-social-commons': {
            title: 'The Social Commons',
            description: 'Investigating models of collective well-being, shared resources, and community-driven initiatives beyond market forces.',
        },
        'critical-methodologies': {
            title: 'Critical Methodologies',
            description: 'Delving into innovative research approaches, interdisciplinary methods, and ethical considerations in critical studies.',
        }
    };


    // Helper function to parse CSV data (reused across site)
    // This function will parse the comprehensive sheet
    function parseCSV(csvText) {
        const lines = csvText.trim().split('\n');
        if (lines.length === 0) return [];

        const parseLine = (line) => {
            const values = [];
            let inQuote = false;
            let currentVal = '';
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                if (char === '"') {
                    inQuote = !inQuote;
                    if (!inQuote && i < line.length - 1 && line[i+1] === '"') {
                        currentVal += '"';
                        i++;
                    }
                } else if (char === ',' && !inQuote) {
                    values.push(currentVal.trim());
                    currentVal = '';
                } else {
                    currentVal += char;
                }
            }
            values.push(currentVal.trim());
            return values;
        };

        const headers = parseLine(lines[0]).map(header => {
            return header.trim().replace(/[^a-zA-Z0-9]/g, '');
        });
        
        const data = [];
        for (let i = 1; i < lines.length; i++) {
            const values = parseLine(lines[i]);
            if (values.length !== headers.length) {
                console.warn(`Skipping malformed row (header/value count mismatch): ${lines[i]}`);
                continue;
            }
            const rowObject = {};
            headers.forEach((header, index) => {
                rowObject[header] = values[index] ? values[index] : '';
                rowObject[`${header}Normalized`] = values[index] ? values[index].toLowerCase().trim() : '';
            });

            // Ensure 'Field' column is parsed as a lowercase, hyphenated array for filtering
            if (rowObject.Field) {
                rowObject.FieldParsed = rowObject.Field.toLowerCase().split(',').map(f => f.trim().replace(/\s/g, '-')).filter(Boolean);
            } else {
                rowObject.FieldParsed = []; // Use FieldParsed to avoid conflict with FieldNormalized property in some RSS items
            }
            data.push(rowObject);
        }
        return data;
    }

    // Generic function to fetch and display data from the comprehensive sheet with filters
    async function fetchDataAndDisplay(url, targetContainerId, renderFunction, currentFieldName = null, filterOptions = {}) {
        const container = document.getElementById(targetContainerId);
        const loadingElement = container.querySelector('.loading-message');
        const comingSoonElement = container.querySelector('.coming-soon');

        if (comingSoonElement) comingSoonElement.style.display = 'none';
        if (loadingElement) loadingElement.style.display = 'block';
        container.innerHTML = ''; // Clear previous content

        try {
            const response = await fetch(url);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const csvText = await response.text();
            let data = parseCSV(csvText);

            // Filter by field name from URL
            if (currentFieldName) {
                const normalizedFieldName = currentFieldName.toLowerCase().replace(/\s/g, '-'); 
                data = data.filter(item => 
                    item.FieldParsed && item.FieldParsed.includes(normalizedFieldName) 
                );
            }

            // Apply additional filter options (e.g., by Medium, FoundationalStatus)
            if (filterOptions.medium) {
                data = data.filter(item => 
                    item.MediumNormalized && item.MediumNormalized.includes(filterOptions.medium.toLowerCase())
                );
            }
            if (filterOptions.foundationalStatus) {
                data = data.filter(item => 
                    item.FoundationalStatusNormalized && item.FoundationalStatusNormalized === filterOptions.foundationalStatus.toLowerCase()
                );
            }
            
            if (data.length === 0) {
                if (comingSoonElement) comingSoonElement.style.display = 'block';
                else container.innerHTML = `<p class="loading-message">no content available for this section yet.</p>`;
                return;
            }

            const itemsToShow = data.slice(0, 3); // Still limiting to 3 for these sections

            itemsToShow.forEach(item => {
                const card = renderFunction(item);
                if (card) {
                    container.appendChild(card);
                }
            });
        } catch (error) {
            console.error(`Error fetching or rendering data for ${targetContainerId} from ${url}:`, error);
            container.innerHTML = `<p class="loading-message error-message">failed to load content for this section. Please check the sheet URL or ensure it's published correctly.</p>`;
        } finally {
            if (loadingElement) {
                loadingElement.style.display = 'none';
            }
        }
    }

    // --- NEW RSS List Variables (for vertical scroll) ---
    let verticalRssArticles = []; 

    // NEW: Function to render RSS articles in a scrollable vertical list
    function renderVerticalRssList(articles) {
        const listContainer = document.getElementById('vertical-rotator-content-wrapper'); // This is now a simple list container
        listContainer.innerHTML = ''; // Clear previous content

        // Sort articles again by pubDate (newest first) to ensure freshness
        articles.sort((a, b) => {
            const dateA = Date.parse(a.pubDate);
            const dateB = Date.parse(b.pubDate);
            if (isNaN(dateA) && isNaN(dateB)) return 0;
            if (isNaN(dateA)) return 1;
            if (isNaN(dateB)) return -1;
            return dateB - dateA;
        });

        // Limit to 10 articles for display in the scrollable list (adjust as desired)
        verticalRssArticles = articles.slice(0, 10); 

        if (verticalRssArticles.length === 0) {
            listContainer.innerHTML = '<p class="loading-message">No recent articles available for this field.</p>';
            return;
        }

        const articlesList = document.createElement('ol'); // Changed to <ol> for numbering
        articlesList.className = 'vertical-articles-list'; 
        listContainer.appendChild(articlesList);

        verticalRssArticles.forEach(article => {
            const articleItem = document.createElement('li'); // Changed to <li> for numbering
            articleItem.classList.add('vertical-article-item');

            // Removed image HTML as requested
            // let imageHtml = '';
            // if (article.imageUrl && article.imageUrl.startsWith('/images/')) {
            //     const backendBaseUrl = BACKEND_RSS_API_URL.replace('/api/field-rss', '');
            //     imageHtml = `<div class="article-thumb-container">
            //                     <img src="${backendBaseUrl}${article.imageUrl}" alt="${article.title}" class="article-thumb">
            //                  </div>`;
            // } else {
            //     imageHtml = `<div class="article-thumb-container placeholder-thumb">
            //                     <img src="images/placeholder.png" alt="No image available" class="article-thumb">
            //                  </div>`;
            // }

            articleItem.innerHTML = `
                <div class="article-text-content">
                    <h3 class="article-title-small"><a href="${article.link}" target="_blank" rel="noopener noreferrer">${article.title}</a></h3>
                    <p class="article-meta-small">Source: ${article.feedTitle || 'N/A'} | ${new Date(article.pubDate).toLocaleDateString()}</p>
                </div>
            `;
            articlesList.appendChild(articleItem);
        });
    }

    // --- REMOVED: Auto-rotation and navigation functions (showVerticalSlide, startVerticalRotator, stopVerticalRotator) ---
    // Because we are now using native scrolling, these are not needed.


    // --- FETCHES RSS ARTICLES FROM YOUR BACKEND API ---
    async function fetchFieldRssFeeds(currentFieldName) {
        // Corrected ID to match HTML: rss-vertical-list-section is the parent, content-wrapper is child
        const listSection = document.getElementById('rss-vertical-list-section'); // Renamed ID
        const listContentWrapper = document.getElementById('vertical-rotator-content-wrapper'); // Renamed ID

        const loadingMessage = listContentWrapper.querySelector('.loading-message') || document.createElement('p');
        if (!loadingMessage.parentNode) {
            loadingMessage.className = 'loading-message';
            listContentWrapper.appendChild(loadingMessage);
        }
        loadingMessage.innerHTML = '<div class="loader"></div>' + (loadingMessage.dataset.originalText || loadingMessage.textContent || 'loading live RSS articles...');
        loadingMessage.dataset.originalText = loadingMessage.dataset.originalText || loadingMessage.textContent;
        loadingMessage.style.display = 'block';

        try {
            // Fetch from your backend API!
            const response = await fetch(`${BACKEND_RSS_API_URL}?field=${currentFieldName}`);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const articles = await response.json(); // Get all filtered articles

            console.log("Articles received for", currentFieldName, ":", articles); 

            if (articles.length === 0) {
                listContentWrapper.innerHTML = `<p class="loading-message">no recent articles available for this field yet.</p>`;
                return;
            }

            // NEW: Render the articles in the scrollable list format
            renderVerticalRssList(articles); // Call the new rendering function

        } catch (error) {
            console.error('Error fetching RSS articles from backend:', error);
            listContentWrapper.innerHTML = `<p class="loading-message error-message">Failed to load live RSS feed. Please ensure backend is running or check network.</p>`;
        } finally {
            loadingMessage.style.display = 'none';
        }
    }


    // --- Render Functions for Field Page Sections ---
    // These remain the same. They are used by fetchDataAndDisplay for non-RSS sections.
    function renderFieldNotesCard(item) {
        // This is a placeholder for actual comments. For now, it will show a Coming Soon message.
        const card = document.createElement('div'); 
        card.className = 'coming-soon'; 
        card.innerHTML = `<p>Field Notes (User Comments) coming soon!</p>`;
        return card;
    }

    // NEW: Render function for Foundational Resources as a simple list item
    function renderFoundationalResourceItem(item) {
        const listItem = document.createElement('li'); // Renders as a list item
        listItem.innerHTML = `
            <a href="${item.Link || '#'}" target="_blank" rel="noopener noreferrer">${item.Title || 'untitled resource'}</a>
            <span class="item-meta">by ${item.Author || 'N/A'} &mdash; ${item.Medium || 'resource'}</span>
        `;
        return listItem;
    }

    function renderWeeklyBriefingCard(item) {
        const card = document.createElement('a');
        card.href = item.Link || '#';
        card.target = '_blank';
        card.rel = 'noopener noreferrer';
        card.className = 'feature-card';
        card.innerHTML = `
            <div class="feature-card-content">
                <h4>${item.Title || 'untitled briefing'}</h4>
                <p>${item.Description || 'no summary provided.'}</p>
                <div class="feature-card-meta">
                    ${item.Date || 'n.d.'}
                </div>
            </div>
        `;
        return card;
    }
    
    // Unused render functions for specific content types for simplicity
    function renderPeopleInstitutionsCard(item) { /* ... */ return null; }
    function renderFormalPublicationCard(item) { /* ... */ return null; }
    function renderReadingListCard(item) { /* ... */ return null; }
    function renderUpcomingEventCard(item) { /* ... */ return null; }


    // --- Main Field Page Initialization (handles both index and individual fields) ---
    document.addEventListener('DOMContentLoaded', () => {
        const mainContentArea = document.getElementById('main-content-area');
        const urlParams = new URLSearchParams(window.location.search);
        const fieldNameParam = urlParams.get('name');

        if (fieldNameParam) {
            // --- Render Individual Field Page ---
            const fieldDetails = fieldData[fieldNameParam];

            if (fieldDetails) {
                document.title = `${fieldDetails.title} | Critical Fields`;

                // NEW HTML STRUCTURE FOR INDIVIDUAL FIELD PAGE
                // Main content is now just a stack of sections
                mainContentArea.innerHTML = `
                    <section class="field-hero">
                        <h2 id="field-title">${fieldDetails.title}</h2>
                        <p id="field-description">${fieldDetails.description}</p>
                    </section>

                    <div class="top-content-row">
                        <div class="column-half live-feed-column content-area">
                            <section id="rss-vertical-list-section" class="content-area">
                                <h3 class="field-section-title">Archive Blog</h3> <div class="vertical-articles-list-wrapper" id="vertical-rotator-content-wrapper">
                                    <p class="loading-message">Loading recent articles...</p>
                                </div>
                            </section>
                        </div>

                        <div class="column-half hero-column content-area">
                            <section id="foundational-resources-section" class="content-area">
                                <h3 class="field-section-title">Foundational Resources</h3> <div id="foundational-resources-container" class="basic-numbered-list">
                                    <p class="loading-message">Loading foundational resources...</p>
                                </div>
                            </section>
                        </div>
                    </div>


                    <section class="content-area">
                        <h3 class="field-section-title">Field Notes</h3>
                        <div id="field-notes-container" class="content-grid">
                            <p class="loading-message">Loading original essays and critiques...</p>
                            <p class="coming-soon">Field Notes (User Comments) coming soon!</p>
                        </div>
                    </section>

                    <section class="content-area">
                        <h3 class="field-section-title">Weekly Briefing (Newsletter)</h3>
                        <div id="weekly-briefing-container" class="content-grid">
                            <p class="loading-message">Loading latest briefings...</p>
                        </div>
                    </section>
                `;

                // *** CALLS TO FETCH DATA ***
                fetchFieldRssFeeds(fieldNameParam); // Calls your new backend for RSS articles (now renders vertical list)

                // Call fetchDataAndDisplay for other sections, now using the comprehensive sheet
                // You MUST add the "FoundationalStatus" column to your Google Sheet for this to work
                fetchDataAndDisplay(GOOGLE_SHEET_COMPREHENSIVE_ARCHIVE_URL, 'foundational-resources-container', renderFoundationalResourceItem, fieldNameParam, { foundationalStatus: 'yes' });
                // Assuming 'Newsletter' is the medium type for your weekly briefings
                fetchDataAndDisplay(GOOGLE_SHEET_COMPREHENSIVE_ARCHIVE_URL, 'weekly-briefing-container', renderWeeklyBriefingCard, fieldNameParam, { medium: 'newsletter' });

                // Field Notes: No fetchDataAndDisplay call needed, handled by static HTML "coming-soon"
            } else {
                mainContentArea.innerHTML = `
                    <section class="field-hero">
                        <h2 id="field-title">Field Not Found</h2>
                        <p id="field-description">The requested field could not be found. Please check the URL or select a field from the navigation.</p>
                    </section>
                `;
            }

        } else {
            // --- Render Fields Index Page ---
            document.title = 'Fields | Critical Fields';
            // The field index page also needs its main element wrapped in .column-full-width for consistent styling
            mainContentArea.innerHTML = `
                <section class="field-hero">
                    <h2>Our Fields of Inquiry</h2>
                    <p>Explore the critical conversations shaping our understanding of the world.</p>
                </section>
                <div id="field-index-wrapper">
                    <div id="field-catalog-container">
                        </div>
                </div>
            `;
            renderFieldIndexPage(); // Call function to render index cards
        }
    });

    // New function to render the main Fields landing page (Digital Card Catalog)
    function renderFieldIndexPage() {
        const container = document.getElementById('field-catalog-container');
        if (!container) return; 

        container.innerHTML = '';

        for (const key in fieldData) {
            if (fieldData.hasOwnProperty(key)) {
                const field = fieldData[key];
                const catalogItem = document.createElement('a');
                catalogItem.href = `fields.html?name=${key}`;
                catalogItem.className = 'field-catalog-item';
                catalogItem.innerHTML = `
                    <h3 class="catalog-title">${field.title}</h3>
                    <p class="catalog-description">${field.description}</p>
                    <span class="cta-link">explore field &rsaquo;</span>
                `;
                container.appendChild(catalogItem);
            }
        }
    }
  </script>
</body>
</html>
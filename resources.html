<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Archive | Critical Fields</title>
  <link rel="stylesheet" href="styles.css" />
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono&display=swap" rel="stylesheet">
  <style>
    /* Styles for the Archive Page, integrated with the new retro-tech theme */
    
    /* Hero Section (consistent with homepage) */
    .hero {
      padding: 2rem 2rem 0.5rem; /* Reduced top and bottom padding */
      text-align: center;
      max-width: 2000px;
      margin: 0 auto;
      background-color: transparent;
      color: var(--color-text-primary);
      border-bottom: 1px solid var(--color-border-dark);
    }

    .hero .tagline {
      font-size: 2rem; /* Reduced font size for tagline */
      font-weight: normal;
      text-transform: uppercase;
      margin-top: 0.5rem; /* Reduced margin below tagline */
      margin-bottom: 0rem; /* Reduced margin below tagline */
      color: var(--color-accent-highlight);
      line-height: 1.0;
      text-shadow: 0 0 10px rgba(255, 65, 54, 0.5);
      /* Typewriter effect styles are in styles.css for .typewriter-text */
    }

    .hero .intro {
      margin: 2rem auto 2rem; /* Reduced margins */
      font-size: 1rem;
      color: var(--color-text-secondary);
      line-height: 1.7;
      max-width: 1500px;
      text-align: center;
    }

    /* Main Filter Container (consistent with homepage's content sections) */
    #main-filter-container {
        background-color: var(--color-card-bg);
        padding: 1.5rem 2rem;
        border-bottom: 1px solid var(--color-border-dark);
        border-top: 1px solid var(--color-border-dark);
        box-shadow: var(--shadow-outset-top), var(--shadow-outset-bottom),
                    4px 4px 0px var(--color-border-dark);
        display: flex;
        flex-direction: column;
        gap: 1.0rem;
        align-items: center;
        max-width: 1200px;
        margin: 2rem auto; /* Reduced top margin */
    }

    /* Filter Group labels and tags (consistent) */
    .filter-group label {
        font-weight: bold;
        color: var(--color-text-primary);
        font-size: 1rem;
        flex-shrink: 0;
        text-transform: lowercase;
        margin-right: 0.5rem;
    }

    .filter-tags-container {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        flex-grow: 1;
        justify-content: center;
    }

    .filter-tag {
        background-color: var(--color-secondary-bg);
        color: var(--color-text-primary);
        padding: 0.4rem 0.8rem;
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.2s ease;
        border: 1px solid var(--color-border-dark);
        user-select: none;
        white-space: nowrap;
        text-transform: lowercase;
        box-shadow: 1px 1px 0px var(--color-border-dark), 2px 2px 0px rgba(0,0,0,0.2);
    }

    .filter-tag:hover {
        background-color: rgba(220, 38, 38, 0.1);
        color: var(--color-ui-red-light);
        box-shadow: 1px 1px 0px var(--color-border-dark), 2px 2px 0px rgba(0,0,0,0.3);
    }

    .filter-tag.selected {
        background-color: var(--color-ui-red);
        color: white;
        border-color: var(--color-ui-red);
        box-shadow: inset 1px 1px 0px var(--color-border-dark), inset -1px -1px 0px var(--color-border-light);
        transform: translate(1px, 1px);
    }

    #search-bar {
        width: 100%;
        max-width: 800px;
        padding: 0.75rem 1rem;
        border: 1px solid var(--color-border-dark);
        border-radius: 4px;
        font-size: 0.95rem;
        color: var(--color-text-primary);
        background-color: var(--color-secondary-bg);
        box-shadow: inset 1px 1px 0px var(--color-border-dark), inset -1px -1px 0px var(--color-border-light);
    }
    #search-bar::placeholder {
        color: var(--color-text-secondary);
        opacity: 0.7;
    }
    #search-bar:focus {
        outline: none;
        border-color: var(--color-ui-red);
        box-shadow: inset 1px 1px 0px var(--color-border-dark), inset -1px -1px 0px var(--color-border-light), 0 0 5px rgba(220, 38, 38, 0.5);
    }

    #clear-filters-btn {
        background-color: var(--color-ui-red);
        color: white;
        padding: 0.75rem 1.5rem;
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.2s ease;
        border: none;
        font-size: 0.95rem;
        font-weight: 600;
        text-transform: lowercase;
        box-shadow: var(--shadow-outset-top), var(--shadow-outset-bottom);
    }

    #clear-filters-btn:hover {
        background-color: var(--color-ui-red-light);
        box-shadow: var(--shadow-outset-top), var(--shadow-outset-bottom);
    }
    #clear-filters-btn:active {
        transform: translate(1px, 1px);
        box-shadow: var(--shadow-inset-top), var(--shadow-inset-bottom);
    }

    /* Active Filters Display (consistent) */
    #active-filters-display {
        margin: 1.5rem auto;
        max-width: 1200px;
        padding: 0 2rem;
        min-height: 1.5rem;
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        gap: 0.75rem;
        font-size: 0.9rem;
        color: var(--color-text-secondary);
        border-top: 1px dashed var(--color-border-dark);
        padding-top: 1rem;
    }

    .active-filter-badge {
        background-color: var(--color-ui-red);
        color: white;
        padding: 0.3rem 0.6rem;
        padding-right: 0.3rem;
        border-radius: 3px;
        font-size: 0.8rem;
        display: inline-flex;
        align-items: center;
        gap: 0.2rem;
        text-transform: lowercase;
        border: 1px solid var(--color-border-dark);
        box-shadow: 1px 1px 0px rgba(0,0,0,0.3);
    }

    .active-filter-badge .remove-filter {
        background: none;
        border: none;
        color: white;
        font-weight: bold;
        cursor: pointer;
        font-size: 0.8rem;
        padding: 0 0.1rem;
        line-height: 1;
        opacity: 0.9;
        transition: opacity 0.2s ease;
    }
    .active-filter-badge .remove-filter:hover {
        opacity: 1;
        text-shadow: 0 0 5px white;
    }
    .active-filter-badge .filter-type-label {
        font-weight: normal;
        opacity: 0.8;
        margin-right: 0.2rem;
        color: var(--color-text-primary);
    }
    .active-filter-badge p {
        color: var(--color-text-secondary);
        font-style: italic;
        font-size: 0.9rem;
    }

    /* Resource Cards (Archive Page) - Enhanced for Hover Effect & Bookshelf Feel */
    #resources-container {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 1.5rem; /* Space between cards */
        padding: 2rem;
        max-width: 1200px;
        margin: 0 auto;
    }

    .resource-card {
        position: relative;
        height: 350px; /* Fixed height for consistent "book" size */
        overflow: hidden;
        border-radius: 4px;
        background: var(--color-card-bg);
        border: 1px solid var(--color-border-dark);
        box-shadow: var(--shadow-outset-top), var(--shadow-outset-bottom),
                    4px 4px 0px var(--color-border-dark);
        transition: transform 0.2s ease, box-shadow 0.2s ease;
        text-decoration: none;
        color: inherit;
        cursor: pointer;
        display: flex;
        flex-direction: column;
    }

    .resource-card:hover {
        transform: translate(-2px, -2px);
        box-shadow: var(--shadow-outset-top), var(--shadow-outset-bottom),
                    6px 6px 0px rgba(0,0,0,0.4);
    }

    .resource-card-image {
        width: 100%;
        height: 180px; /* Fixed height for image area */
        object-fit: cover;
        background-color: var(--color-secondary-bg);
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--color-text-secondary);
        font-size: 1.2rem;
        font-weight: bold;
        border-bottom: 1px solid var(--color-border-dark);
    }
    .resource-card-image img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .resource-header {
        padding: 0.5rem 1rem 0.5rem; /* Reduced padding-top, added padding-bottom */
        border-bottom: 1px dashed var(--color-border-dark);
        background-color: var(--color-secondary-bg); /* Background for header */
        flex-shrink: 0;
        color: var(--color-text-primary);
    }
    .resource-header h3 {
        margin: 0;
        font-size: 1.05rem;
        color: var(--color-accent-highlight);
        line-height: 1.3;
        text-transform: lowercase;
    }
    .resource-header .tags-container {
        font-size: 0.75rem;
        color: var(--color-text-secondary);
        margin-top: 0.4rem;
        display: flex;
        flex-wrap: wrap;
        gap: 0.3rem;
    }
    .resource-header .tag-badge {
        background-color: var(--color-main-bg); /* Changed to main-bg (lightest) */
        color: var(--color-text-primary); /* Dark text on light badge */
        padding: 0.15rem 0.4rem;
        border-radius: 2px;
        border: 1px solid var(--color-border-light); /* Lighter border */
        box-shadow: 0.5px 0.5px 0px var(--color-border-dark);
        text-transform: lowercase;
    }

    /* Hover Overlay for Description */
    .resource-hover-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.85); /* Slightly more opaque black overlay */
        color: white; /* Ensure text is white for high contrast on dark overlay */
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        padding: 1rem;
        opacity: 0;
        transform: translateY(100%);
        transition: opacity 0.3s ease, transform 0.3s ease;
        box-sizing: border-box;
        text-align: center;
    }

    .resource-card:hover .resource-hover-overlay {
        opacity: 1;
        transform: translateY(0);
    }

    .resource-hover-overlay p {
        font-size: 0.95rem;
        line-height: 1.6;
        margin-bottom: 1rem;
        color: white; /* Explicitly white for readability */
        opacity: 0.9;
    }

    .resource-hover-overlay .read-more-link {
        color: var(--color-ui-red-light);
        text-decoration: underline;
        font-weight: bold;
        font-size: 0.9rem;
        text-transform: lowercase;
    }
    .resource-hover-overlay .read-more-link:hover {
        color: white;
    }


    /* Loading and Error Messages (consistent) */
    .loading-message {
        text-align: center;
        padding: 2rem;
        font-size: 1.1rem;
        color: var(--color-text-secondary);
        grid-column: 1 / -1;
        font-style: italic;
        border: 1px dashed var(--color-border-dark);
        border-radius: 4px;
        background-color: var(--color-secondary-bg);
    }
    .error-message {
        color: var(--color-ui-red);
        font-weight: bold;
    }

    /* Footer (consistent) */
    footer.site-footer {
      text-align: center;
      font-size: 0.85rem;
      padding: 1.5rem;
      color: var(--color-text-secondary);
      border-top: 1px solid var(--color-border-dark);
      background-color: var(--color-secondary-bg);
      margin-top: 4rem;
    }

    /* Responsive adjustments */
    @media (max-width: 768px) {
        .resource-card {
            height: 300px; /* Adjust height for smaller screens */
        }
        .resource-card-image {
            height: 150px;
        }
        .resource-header h3 {
            font-size: 1rem;
        }
        .resource-header .tags-container {
            font-size: 0.7rem;
        }
        .resource-hover-overlay p {
            font-size: 0.85rem;
        }
    }

    /* Styles for dropdown menu */
.navbar .dropdown {
    position: relative;
}

.navbar .dropdown-menu {
    display: none;
    position: absolute;
    background-color: var(--color-secondary-bg);
    box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
    z-index: 1;
    min-width: 160px;
    list-style: none;
    padding: 0;
    margin: 0;
    border: 1px solid var(--color-border-dark);
    border-radius: 4px;
    left: 0; /* Align dropdown with the parent link */
    top: 100%; /* Position below the parent link */
}

.navbar .dropdown-menu li a {
    color: var(--color-text-primary);
    padding: 12px 16px;
    text-decoration: none;
    display: block;
    text-align: left;
    white-space: nowrap; /* Prevent wrapping */
}

.navbar .dropdown-menu li a:hover {
    background-color: var(--color-main-bg);
    color: var(--color-accent-highlight);
}

.navbar .dropdown:hover .dropdown-menu {
    display: block;
}
  </style>
</head>
<body>
  <header class="site-header">
    <nav class="navbar">
      <h1 class="logo">Critical Fields</h1>
      <ul class="nav-menu">
        <li><a href="index.html">Home</a></li>
        <li class="dropdown">
          <a href="fields.html">Fields</a>
          <ul class="dropdown-menu">
            <li><a href="fields.html?name=heterodox-economics">Heterodox Economics</a></li>
            <li><a href="fields.html?name=architectures-of-power">Architectures of Power</a></li>
            <li><a href="fields.html?name=the-digital-apparatus">The Digital Apparatus</a></li>
            <li><a href="fields.html?name=earth-systems">Earth Systems</a></li>
            <li><a href="fields.html?name=the-social-commons">The Social Commons</a></li>
            <li><a href="fields.html?name=critical-methodologies">Critical Methodologies</a></li>
          </ul>
        </li>
        <li class="dropdown">
  <a href="#">Archive</a> <ul class="dropdown-menu">
    <li><a href="resources.html">Resources</a></li>
    <li><a href="files.html">Files</a></li>
  </ul>
</li>
        <li><a href="network.html">Network</a></li>
        <li><a href="about.html">About</a></li>
      </ul>
    </nav>
  </header>

  <main>
    <section class="hero">
      <h2 class="tagline typewriter-text" style="font-size: 2rem; text-transform: lowercase; margin-bottom: -1rem;">welcome to the archive</h2> <!-- Reduced font size via inline style -->
      <p class="intro">
        The engine room of Critical Fields: a living, open-access archive. This curated repository houses essential resources for critical learning, serving as the foundational material for our Fields, our in-depth analysis, and our impactful conversations. We're committed to building a robust knowledge commons, and this archive is the core of that collective endeavor.
      </p>
    </section>

    <div id="main-filter-container">
        <input type="text" id="search-bar" placeholder="search by title or description..." aria-label="Search resources">

        <div class="filter-group">
            <label>Resource Type:</label>
            <div id="resource-type-filters" class="filter-tags-container">
                <span class="filter-tag all-tag selected" data-filter-type="ResourceType" data-filter-value="all">all</span>
            </div>
        </div>

        <div class="filter-group">
            <label>Field:</label>
            <div id="field-filters" class="filter-tags-container">
                <span class="filter-tag all-tag selected" data-filter-type="Field" data-filter-value="all">all</span>
            </div>
        </div>

        <button id="clear-filters-btn">clear all filters</button>
    </div>

    <div id="active-filters-display">
        </div>

    <div id="resources-container">
        <p class="loading-message" id="loading-resources">
            <div class="loader"></div>
            Loading resources...
        </p>
    </div>
  </main>

  <footer class="site-footer">
    <p>&copy; 2025 critical fields.</p>
  </footer>

  <script>
    // --- Configuration ---
    // Original Google Sheet CSV URL
    const GOOGLE_SHEET_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSdn5xz0N63Dzl0n7PRGNTBLk5RkcddzJQ4MoObZJFNeE-9qUbYkdO49bgGlwUyJnby0innAVYaVR7n/pub?output=csv';
    // CORS Proxy URL
    const CORS_PROXY_BASE_URL = 'https://api.allorigins.win/raw?url=';
    // Combined URL for fetching via proxy
    const MAIN_ARCHIVE_SHEET_URL = CORS_PROXY_BASE_URL + encodeURIComponent(GOOGLE_SHEET_CSV_URL);


    let allResources = [];
    let selectedResourceTypes = new Set(['all']);
    let selectedField = new Set(['all']);
    let searchQuery = '';

    // MAPPING from detailed Medium values (from your sheet) to broader ResourceType categories
    // ALL keys are LOWERCASE and TRIMMED to ensure robust matching.
    const mediumCategoryMap = {
        // Literature
        "peer reviewed journal": "Literature",
        "book": "Literature",
        "dissertation": "Literature",
        "blog": "Literature",
        "publication": "Literature",
        "newsletter": "Literature",
        "substack": "Literature",
        "book reviews": "Literature",
        "editor selection": "Literature",

        // Multimedia
        "podcast": "Multimedia",
        "film": "Multimedia",
        "interview": "Multimedia",
        "data visualizations": "Multimedia",
        "datasets": "Multimedia",
        "video essay": "Multimedia",
        "youtube account": "Multimedia",
        "art": "Multimedia",

        // Educational Resources
        "resource": "Educational Resources",
        "reading list": "Educational Resources",
        "course": "Educational Resources",
        "syllabi": "Educational Resources",
        "lecture series": "Educational Resources",
        "community": "Educational Resources",
        "project": "Educational Resources",

        // Fallback for any unmapped mediums or empty values
        "other": "Other",
        "": "Other"
    };

    // Define priority for Resource Types (earlier in array means higher priority)
    const resourceTypePriority = ["Multimedia", "Literature", "Educational Resources", "Other"];

    // Helper function to parse CSV data
    function parseCSV(csvText) {
        const lines = csvText.trim().split('\n');
        if (lines.length === 0) return [];

        const parseLine = (line) => {
            const values = [];
            let inQuote = false;
            let currentVal = '';
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                if (char === '"') {
                    inQuote = !inQuote;
                    if (!inQuote && i < line.length - 1 && line[i+1] === '"') {
                        currentVal += '"';
                        i++;
                    }
                } else if (char === ',' && !inQuote) {
                    values.push(currentVal.trim());
                    currentVal = '';
                } else {
                    currentVal += char;
                }
            }
            values.push(currentVal.trim());
            return values;
        };

        const headers = parseLine(lines[0]).map(header => {
            return header.trim().replace(/[^a-zA-Z0-9]/g, '');
        });

        console.log("Parsed Headers:", headers); // Debug log for headers

        const data = [];
        for (let i = 1; i < lines.length; i++) {
            const values = parseLine(lines[i]);
            if (values.length !== headers.length) {
                console.warn(`Skipping malformed row (header/value count mismatch): ${lines[i]}`);
                continue;
            }
            const rowObject = {};
            headers.forEach((header, index) => {
                rowObject[header] = values[index] ? values[index] : ''; // Store original value for display
                // For internal logic/filtering, also store a lowercase, trimmed version
                rowObject[`${header}Normalized`] = values[index] ? values[index].toLowerCase().trim() : '';
            });
            
            // --- REFINED LOGIC for handling multiple mediums and assigning ResourceType ---
            const rawMediumString = rowObject.MediumNormalized; // Use normalized for lookup
            const individualMediums = rawMediumString.split(',').map(m => m.trim()).filter(Boolean);

            let assignedResourceType = mediumCategoryMap['']; // Default to 'Other'
            let foundTypesForThisRow = new Set(); 

            for (const medium of individualMediums) {
                const mappedType = mediumCategoryMap[medium];
                if (mappedType && mappedType !== 'Other' && mappedType !== '') {
                    foundTypesForThisRow.add(mappedType);
                }
            }

            if (foundTypesForThisRow.size > 0) {
                for (const priorityType of resourceTypePriority) {
                    if (foundTypesForThisRow.has(priorityType)) {
                        assignedResourceType = priorityType;
                        break;
                    }
                }
            }
            rowObject.ResourceType = assignedResourceType;
            
            // Handle multiple fields: split the 'Field' string into an array of individual fields
            if (rowObject.Field) {
                rowObject.Field = rowObject.FieldNormalized.split(',').map(f => f.trim()).filter(Boolean); // Store original case for display
                rowObject.FieldNormalized = rowObject.Field.map(f => f.toLowerCase()); // Store normalized for filtering
            } else {
                rowObject.Field = [];
                rowObject.FieldNormalized = [];
            }

            // Detailed debug log for each row's medium processing
            console.groupCollapsed(`Medium/Field processing for row: "${rowObject.Title}"`);
            console.log(`Original Medium: "${rowObject.Medium}" -> Processed as: [${individualMediums.map(m => `"${m}"`).join(', ')}]`);
            console.log(`Mapped types found: [${[...foundTypesForThisRow].map(t => `"${t}"`).join(', ')}]`);
            console.log(`Final assigned ResourceType: "${rowObject.ResourceType}"`);
            console.log(`Original Field: "${rowObject.Field}" -> Processed as: [${(rowObject.FieldNormalized || []).map(f => `"${f}"`).join(', ')}]`);
            console.groupEnd();
            
            data.push(rowObject);
        }
        return data.sort((a, b) => (a.Title > b.Title) ? 1 : -1); // Alphabetical sort by Title
    }

    // Renders a single resource card for Archive
    function renderResourceCard(item) {
        const card = document.createElement('a');
        card.href = item.Link || '#';
        card.target = "_blank";
        card.rel = "noopener noreferrer";
        card.className = 'resource-card';

        const imageUrl = item.ImageLink && item.ImageLink.startsWith('http') ? item.ImageLink : 'https://placehold.co/400x180/E0E0E0/666666?text=No+Image';

        let imageContent = imageUrl.includes('placehold.co') ? 
                            `<div class="resource-card-image" style="background-color: var(--color-secondary-bg); display: flex; align-items: center; justify-content: center; color: var(--color-text-secondary); font-size: 1.2rem;">No Image</div>` : 
                            `<img src="${imageUrl}" alt="${item.Title || 'Resource image'}" class="resource-card-image" onerror="this.onerror=null;this.src='https://placehold.co/400x180/E0E0E0/666666?text=Image+Load+Error';"/>`;


        const mediumTag = item.Medium ? `<span class="tag-badge">${item.Medium}</span>` : '';
        const fieldTagsHtml = item.Field && item.Field.length > 0
            ? item.Field.map(f => `<span class="tag-badge">${f}</span>`).join('')
            : '';

        card.innerHTML = `
            ${imageContent}
            <div class="resource-header">
                <h3>${item.Title || 'untitled resource'}</h3>
                <div class="tags-container">
                    ${mediumTag}
                    ${fieldTagsHtml}
                </div>
            </div>
            <div class="resource-hover-overlay">
                <p>${item.Description || 'no description provided.'}</p>
                <a href="${item.Link || '#'}" target="_blank" rel="noopener noreferrer" class="read-more-link">read more &rsaquo;</a>
            </div>
        `;
        return card;
    }

    // Displays resources in the container
    function displayResources(resourcesToDisplay) {
        const container = document.getElementById('resources-container');
        container.innerHTML = '';

        if (resourcesToDisplay.length === 0) {
            container.innerHTML = `<p class="loading-message">no resources found matching your current filters. try broadening your search.</p>`;
            return;
        }

        resourcesToDisplay.forEach(item => {
            const card = renderResourceCard(item);
            container.appendChild(card);
        });
    }

    // Dynamically generates filter tags and attaches event listeners
    function renderFilterTags(filterType, containerId, allItems) {
        const container = document.getElementById(containerId);
        container.innerHTML = `<span class="filter-tag all-tag selected" data-filter-type="${filterType}" data-filter-value="all">all</span>`;

        let uniqueItems = new Set();
        if (filterType === 'ResourceType') {
            Object.values(mediumCategoryMap).filter(val => val !== 'Other' && val !== '').forEach(type => uniqueItems.add(type));
        } else if (filterType === 'Field') {
            allItems.forEach(item => {
                if (item.Field && Array.isArray(item.Field)) {
                    item.Field.forEach(field => {
                        if (field.toLowerCase() !== 'all') {
                            uniqueItems.add(field);
                        }
                    });
                }
            });
        } else {
            // Fallback for other filter types, using Normalized value
            allItems.map(item => item[`${filterType}Normalized`]).filter(Boolean).forEach(val => uniqueItems.add(val));
        }

        // Sort unique items and create tags
        [...uniqueItems].sort().forEach(itemValue => {
            const tag = document.createElement('span');
            tag.className = 'filter-tag';
            tag.textContent = itemValue.toLowerCase();
            tag.dataset.filterType = filterType;
            tag.dataset.filterValue = itemValue.toLowerCase();

            const selectedSet = filterType === 'ResourceType' ? selectedResourceTypes : selectedField;
            if (selectedSet.has(itemValue.toLowerCase())) {
                tag.classList.add('selected');
            }

            tag.addEventListener('click', handleFilterTagClick);
            container.appendChild(tag);
        });
    }

    // Renders and updates the active filter badges above the results
    function renderActiveFilters() {
        const activeFiltersDisplay = document.getElementById('active-filters-display');
        activeFiltersDisplay.innerHTML = '';

        const appendBadge = (type, value) => {
            const badge = document.createElement('span');
            badge.className = 'active-filter-badge';
            const label = type === 'ResourceType' ? 'type' : 'field';
            badge.innerHTML = `<span class="filter-type-label">${label}:</span> ${value} <button class="remove-filter" data-filter-type="${type}" data-filter-value="${value}">&times;</button>`;
            badge.querySelector('.remove-filter').addEventListener('click', (event) => {
                const filterTypeToRemove = event.target.dataset.filterType;
                const filterValueToRemove = event.target.dataset.filterValue;
                
                const originalTag = document.querySelector(`.filter-tag[data-filter-type="${filterTypeToRemove}"][data-filter-value="${filterValueToRemove}"]`);
                if (originalTag) {
                    originalTag.click();
                }
            });
            activeFiltersDisplay.appendChild(badge);
        };

        if (!selectedResourceTypes.has('all') && selectedResourceTypes.size > 0) {
            selectedResourceTypes.forEach(val => appendBadge('ResourceType', val));
        }

        if (!selectedField.has('all') && selectedField.size > 0) {
            selectedField.forEach(val => appendBadge('Field', val));
        }

        if (searchQuery.trim() !== '') {
            const searchBadge = document.createElement('span');
            searchBadge.className = 'active-filter-badge';
            searchBadge.innerHTML = `<span class="filter-type-label">search:</span> "${searchQuery}" <button class="remove-filter" data-filter-type="Search" data-filter-value="${searchQuery}">&times;</button>`;
            searchBadge.querySelector('.remove-filter').addEventListener('click', () => {
                searchQuery = '';
                document.getElementById('search-bar').value = '';
                filterAndDisplayResources();
                renderActiveFilters();
            });
            activeFiltersDisplay.appendChild(searchBadge);
        }

        if (selectedResourceTypes.has('all') && selectedField.has('all') && searchQuery.trim() === '') {
            activeFiltersDisplay.innerHTML = `<p style="margin:0; color:var(--color-text-secondary);">no active filters.</p>`;
        }
    }

    // Handles clicks on filter tags
    function handleFilterTagClick(event) {
        const clickedTag = event.target;
        const filterType = clickedTag.dataset.filterType;
        const filterValue = clickedTag.dataset.filterValue.toLowerCase();

        const selectedSet = filterType === 'ResourceType' ? selectedResourceTypes : selectedField;
        const allTagsInGroup = document.querySelectorAll(`.filter-tag[data-filter-type="${filterType}"]`);
        const allTag = document.querySelector(`.filter-tag.all-tag[data-filter-type="${filterType}"]`);

        if (filterValue === 'all') {
            selectedSet.clear();
            selectedSet.add('all');
            allTagsInGroup.forEach(tag => tag.classList.remove('selected'));
            allTag.classList.add('selected');
        } else {
            if (selectedSet.has('all')) {
                selectedSet.delete('all');
                allTag.classList.remove('selected');
            }
            if (selectedSet.has(filterValue)) {
                selectedSet.delete(filterValue);
                clickedTag.classList.remove('selected');
                if (selectedSet.size === 0) {
                    selectedSet.add('all');
                    allTag.classList.add('selected');
                }
            } else {
                selectedSet.add(filterValue);
                clickedTag.classList.add('selected');
            }
        }
        filterAndDisplayResources();
        renderActiveFilters();
    }

    // Main function to apply all filters and display results
    function filterAndDisplayResources() {
        let currentFilteredResources = allResources.filter(resource => {
            const resourceResourceType = resource.ResourceType ? resource.ResourceType.toLowerCase() : '';
            const resourceTitle = resource.TitleNormalized; // Use normalized for filtering
            const resourceDescription = resource.DescriptionNormalized; // Use normalized for filtering

            // ResourceType filter logic
            const matchesResourceType = selectedResourceTypes.has('all') || selectedResourceTypes.has(resourceResourceType);

            // Field filter logic: Check if ANY selected field is present in the resource's Field array
            const matchesField = selectedField.has('all') ||
                                 (resource.FieldNormalized && resource.FieldNormalized.some(field => selectedField.has(field)));

            // Search filter logic
            const matchesSearch = !searchQuery ||
                                  resourceTitle.includes(searchQuery.toLowerCase()) ||
                                  resourceDescription.includes(searchQuery.toLowerCase());

            return matchesResourceType && matchesField && matchesSearch;
        });

        displayResources(currentFilteredResources);
    }

    // --- Initialize Data Loading and Event Listeners ---
    document.addEventListener('DOMContentLoaded', async () => {
        const loadingMessage = document.getElementById('loading-resources');
        const resourcesContainer = document.getElementById('resources-container');
        const searchBar = document.getElementById('search-bar');
        const clearFiltersBtn = document.getElementById('clear-filters-btn');

        try {
            const response = await fetch(MAIN_ARCHIVE_SHEET_URL);
            if (!response.ok) {
                throw new Error(`HTTP error! Status: ${response.status}. Please ensure the Google Sheet URL is correct and published to web, and CORS proxy is working.`);
            }
            const csvText = await response.text();
            allResources = parseCSV(csvText);

            renderFilterTags('ResourceType', 'resource-type-filters', allResources);
            renderFilterTags('Field', 'field-filters', allResources);

            filterAndDisplayResources();
            renderActiveFilters();

        } catch (error) {
            console.error('Error fetching or processing resources:', error);
            resourcesContainer.innerHTML = `<p class="loading-message error-message">Error loading resources. Please check the console for details. Make sure the Google Sheet URL is correct and published, and CORS proxy is accessible.</p>`;
        } finally {
            if (loadingMessage) {
                 loadingMessage.style.display = 'none';
            }
        }

        searchBar.addEventListener('input', (event) => {
            searchQuery = event.target.value;
            filterAndDisplayResources();
            renderActiveFilters();
        });

        clearFiltersBtn.addEventListener('click', () => {
            selectedResourceTypes.clear();
            selectedResourceTypes.add('all');
            selectedField.clear();
            selectedField.add('all');
            searchQuery = '';
            document.getElementById('search-bar').value = '';

            document.querySelectorAll('.filter-tag').forEach(tag => tag.classList.remove('selected'));
            document.querySelectorAll('.filter-tag.all-tag').forEach(tag => tag.classList.add('selected'));

            filterAndDisplayResources();
            renderActiveFilters();
        });
    });
  </script>
</body>
</html>
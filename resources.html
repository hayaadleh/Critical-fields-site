<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Archive | Critical Fields</title>
  <link rel="stylesheet" href="styles.css" />
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono&display=swap" rel="stylesheet">
  <style>
    /*
      Minimal inline styles added here.
      Most design should come from your styles.css.
      These primarily style the new filter UI components and enhance user experience.
    */
    
    /* Ensure body font and background are from styles.css */
    body {
        font-family: 'IBM Plex Mono', monospace;
        background-color: #f5f5f5; /* From styles.css */
        color: #111; /* From styles.css */
        margin: 0;
        padding: 0;
        line-height: 1.6;
    }

    /* Override hero padding to match initial resources.html, if desired, otherwise styles.css will rule */
   .hero {
      padding: 2rem; /* Adjusted from 4rem in styles.css to match original resources.html padding */
      text-align: center;
    }

    /* Main filter container styling */
    #main-filter-container {
        background-color: #ffffff; /* White background for the filter bar */
        padding: 1.5rem 2rem;
        border-bottom: 1px solid #ddd;
        border-top: 1px solid #ddd;
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
        align-items: center; /* Center horizontally */
    }

    /* Filter group for labels and tags */
   .filter-group {
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        gap: 1rem;
        width: 100%; /* Take full width */
        max-width: 800px; /* Constrain filters to a readable width */
        justify-content: center; /* Center filter tags */
    }

   .filter-group label {
        font-weight: bold;
        color: #111; /* Match body text color */
        font-size: 1.1rem; /* Consistent with nav-menu font size */
        flex-shrink: 0;
        text-transform: lowercase; /* Consistent with site's styling */
    }

   .filter-tags-container {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        flex-grow: 1; /* Allow tags to take up space */
        justify-content: center; /* Center tags within their container */
    }

   .filter-tag {
        background-color: #eee; /* Lighter grey for unselected tags */
        color: #333;
        padding: 0.4rem 0.8rem;
        border-radius: 15px; /* Softer pill shape */
        cursor: pointer;
        transition: background-color 0.2s ease, color 0.2s ease, box-shadow 0.2s ease;
        font-size: 0.85rem; /* Slightly smaller text for tags */
        border: 1px solid #ddd;
        user-select: none; /* Prevent text selection on tags */
        white-space: nowrap; /* Keep tags from breaking onto multiple lines */
        text-transform: lowercase; /* Consistent with site's styling */
    }

   .filter-tag:hover {
        background-color: #ddd;
        box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    }

   .filter-tag.selected {
        background-color: #111; /* Darker, consistent with site's primary color */
        color: white;
        border-color: #111;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }

    #search-bar {
        width: 100%;
        max-width: 800px; /* Match filter group width */
        padding: 0.75rem 1rem;
        border: 1px solid #ccc; /* Match site's borders */
        border-radius: 6px; /* Match site's rounded corners */
        font-size: 0.9rem; /* Match nav-menu font size */
        color: #111;
        background-color: #fff;
    }
    #search-bar::placeholder {
        color: #666;
    }

    #clear-filters-btn {
        background-color: #e0e0e0; /* Neutral grey, less aggressive than red */
        color: #333;
        padding: 0.75rem 1.5rem;
        border-radius: 6px;
        cursor: pointer;
        transition: background-color 0.2s ease, transform 0.1s ease;
        border: 1px solid #ccc;
        font-size: 0.9rem;
        font-weight: 600;
        text-transform: lowercase; /* Consistent with site's styling */
        margin-top: 1rem; /* Space from search/filters */
    }

    #clear-filters-btn:hover {
        background-color: #ccc;
        transform: translateY(-1px);
    }

    /* --- Active Filters Display --- */
    #active-filters-display {
        margin: 1.5rem auto;
        max-width: 1200px;
        padding: 0 2rem; /* Match container padding */
        min-height: 1.5rem; /* Give it some space even when empty */
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        gap: 0.75rem;
        font-size: 0.9rem;
        color: #555;
    }

   .active-filter-badge {
        background-color: #111; /* Dark background to stand out */
        color: white;
        padding: 0.4rem 0.8rem;
        padding-right: 0.5rem; /* Space for X */
        border-radius: 15px;
        font-size: 0.85rem;
        display: inline-flex;
        align-items: center;
        gap: 0.3rem;
        text-transform: lowercase;
        border: 1px solid #111;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }

   .active-filter-badge .remove-filter {
        background: none;
        border: none;
        color: white;
        font-weight: bold;
        cursor: pointer;
        font-size: 0.9rem;
        padding: 0 0.2rem;
        line-height: 1;
        opacity: 0.8;
        transition: opacity 0.2s ease;
    }
   .active-filter-badge .remove-filter:hover {
        opacity: 1;
    }
   .active-filter-badge .filter-type-label {
        font-weight: normal;
        opacity: 0.8;
        margin-right: 0.2rem;
    }

    /* --- Resources Container & Card Styles (Reverted to styles.css base + minimal additions) --- */
    #resources-container {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 1.5rem;
      padding: 2rem;
      max-width: 1200px;
      margin: 0 auto;
    }

   .resource-card {
      position: relative;
      overflow: hidden;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      transition: transform 0.3s ease;
      text-decoration: none;
      color: inherit;
      background: #fff;
      cursor: pointer;
      display: flex;
      flex-direction: column;
      height: 100%;
    }

   .resource-card:hover {
      transform: scale(1.02);
    }

   .resource-image {
        width: 100%;
        height: 180px;
        object-fit: cover;
        background-color: #e2e8f0;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #94a3b8;
        font-size: 1.2rem;
        font-weight: bold;
        overflow: hidden;
    }
   .resource-image img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

   .resource-overlay {
      padding: 1rem;
      flex-grow: 1;
      display: flex;
      flex-direction: column;
    }

   .resource-overlay h3 {
      margin: 0 0 0.5rem;
      font-size: 1.1rem;
      color: #111;
    }

   .resource-description {
        font-size: 0.9rem;
        color: #444;
        margin-bottom: 0.75rem;
        line-height: 1.4;
        flex-grow: 1;
    }

   .tags-container {
      font-size: 0.8rem;
      color: #666;
      margin-top: auto;
      display: flex;
      flex-wrap: wrap;
      gap: 0.4rem;
    }

   .tag-badge {
        background-color: #f0f0f0;
        color: #444;
        padding: 0.2rem 0.5rem;
        border-radius: 4px;
        font-weight: 500;
        white-space: nowrap;
        text-transform: lowercase;
        border: 1px solid #e0e0e0;
    }

   .loading-message {
        text-align: center;
        padding: 2rem;
        font-size: 1.1rem;
        color: #666;
        grid-column: 1 / -1;
    }
   .error-message {
        color: #d9534f;
        font-weight: bold;
    }

    /* Footer from styles.css */
    footer.site-footer {
      text-align: center;
      font-size: 0.75rem;
      padding: 1rem;
      color: #888;
      border-top: 1px solid #ccc;
    }

    /* Responsive adjustments */
    @media (max-width: 768px) {
       .site-header {
            flex-direction: column;
            align-items: flex-start;
        }
       .nav-menu {
            margin-top: 1rem;
            width: 100%;
            justify-content: center;
            gap: 1rem;
        }
       .dropdown {
            width: 100%;
            text-align: center;
        }
       .dropdown-menu {
            width: 100%;
            left: 0;
            right: 0;
        }

       .hero {
            padding: 2rem 1rem;
        }
       .hero .tagline {
            font-size: 1.8rem;
        }
       .hero .intro {
            font-size: 0.95rem;
        }

        #main-filter-container {
            padding: 1rem;
            gap: 1rem;
        }
       .filter-group {
            flex-direction: column;
            align-items: flex-start;
            width: 100%;
            gap: 0.8rem;
        }
       .filter-group label {
            margin-bottom: 0.5rem;
        }
       .filter-tags-container {
            width: 100%;
            justify-content: center;
        }
        #clear-filters-btn {
            width: 100%;
            text-align: center;
        }

        #resources-container {
            grid-template-columns: 1fr;
            padding: 1rem;
            gap: 1rem;
        }
    }
  </style>
</head>
<body>
  <header class="site-header">
    <nav class="navbar">
      <h1 class="logo">Critical Fields</h1>
      <ul class="nav-menu">
        <li><a href="index.html">Home</a></li>
        <li class="dropdown">
          <a href="fields.html">Fields</a>
          <ul class="dropdown-menu">
             <li><a href="fields.html?name=heterodox-economics">Heterodox Economics</a></li>
            <li><a href="fields.html?name=architectures-of-power">Architectures of Power</a></li>
            <li><a href="fields.html?name=the-digital-apparatus">The Digital Apparatus</a></li>
            <li><a href="fields.html?name=earth-systems">Earth Systems</a></li>
            <li><a href="fields.html?name=the-social-commons">The Social Commons</a></li>
            <li><a href="fields.html?name=critical-methodologies">Critical Methodologies</a></li>
          </ul>
        </li>
        <li><a href="resources.html">Archive</a></li>
        <li><a href="network.html">Network</a></li>
        <li><a href="about.html">About</a></li>
      </ul>
    </nav>
  </header>

  <main>
    <section class="hero">
      <h2 class="tagline">Welcome to the Archive</h2>
      <p class="intro">
        This is the living, open-access archive that powers our entire platform—a public, user-fed repository dedicated to collecting and preserving essential resources of critical learning. This archive is the raw material from which we build our Fields, deliver our analysis, and platform conversations. We believe knowledge should be a commons; this is our collective effort to build one.
      </p>
    </section>

    <div id="main-filter-container">
        <input type="text" id="search-bar" placeholder="search by title or description..." aria-label="Search resources">

        <div class="filter-group">
            <label>Resource Type:</label>
            <div id="resource-type-filters" class="filter-tags-container">
                <span class="filter-tag all-tag selected" data-filter-type="ResourceType" data-filter-value="all">all</span>
            </div>
        </div>

        <div class="filter-group">
            <label>Field:</label>
            <div id="field-filters" class="filter-tags-container">
                <span class="filter-tag all-tag selected" data-filter-type="Field" data-filter-value="all">all</span>
            </div>
        </div>

        <button id="clear-filters-btn">clear all filters</button>
    </div>

    <div id="active-filters-display">
        </div>

    <div id="resources-container">
        <p class="loading-message" id="loading-resources">Loading resources from Google Sheet...</p>
    </div>
  </main>

  <footer class="site-footer">
    <p>&copy; 2025 critical fields.</p>
  </footer>

  <script>
    // --- Configuration ---
    // Your published Google Sheet CSV URL
    const GOOGLE_SHEET_RESOURCES_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSdn5xz0N63Dzl0n7PRGNTBLk5RkcddzJQ4MoObZJFNeE-9qUbYkdO49bgGlwUyJnby0innAVYaVR7n/pub?output=csv';

    let allResources = [];
    let selectedResourceTypes = new Set(['all']);
    let selectedField = new Set(['all']);
    let searchQuery = '';

    // MAPPING from detailed Medium values (from your sheet) to broader ResourceType categories
    // ALL keys are LOWERCASE and TRIMMED to ensure robust matching.
    const mediumCategoryMap = {
        // Literature
        "peer reviewed journal": "Literature",
        "book": "Literature",
        "dissertation": "Literature",
        "blog": "Literature",
        "publication": "Literature",
        "newsletter": "Literature",
        "substack": "Literature",
        "book reviews": "Literature",

        // Multimedia
        "podcast": "Multimedia",
        "film": "Multimedia",
        "interview": "Multimedia",
        "data visualizations": "Multimedia",
        "datasets": "Multimedia",
        "video essay": "Multimedia",
        "youtube account": "Multimedia",
        "art": "Multimedia",

        // Educational Resources
        "resource": "Educational Resources",
        "reading list": "Educational Resources",
        "course": "Educational Resources",
        "syllabi": "Educational Resources",
        "lecture series": "Educational Resources",
        "community": "Educational Resources",

        // Fallback for any unmapped mediums or empty values
        "other": "Other",
        "": "Other"
    };

    // Define priority for Resource Types (earlier in array means higher priority)
    const resourceTypePriority = ["Multimedia", "Literature", "Educational Resources"]; // Prioritize Multimedia higher based on your latest issue

    // Helper function to parse CSV data
    function parseCSV(csvText) {
        const lines = csvText.trim().split('\n');
        if (lines.length === 0) return [];

        const parseLine = (line) => {
            const values = [];
            let inQuote = false;
            let currentVal = '';
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                if (char === '"') {
                    inQuote = !inQuote;
                    if (!inQuote && i < line.length - 1 && line[i+1] === '"') {
                        currentVal += '"';
                        i++;
                    }
                } else if (char === ',' && !inQuote) {
                    values.push(currentVal.trim());
                    currentVal = '';
                } else {
                    currentVal += char;
                }
            }
            values.push(currentVal.trim());
            return values;
        };

        const headers = parseLine(lines[0]).map(header => {
            return header.trim().replace(/[^a-zA-Z0-9]/g, '');
        });

        console.log("Parsed Headers:", headers); // Debug log for headers

        const data = [];
        for (let i = 1; i < lines.length; i++) {
            const values = parseLine(lines[i]);
            if (values.length !== headers.length) {
                console.warn(`Skipping malformed row (header/value count mismatch): ${lines[i]}`);
                continue;
            }
            const rowObject = {};
            headers.forEach((header, index) => {
                rowObject[header] = values[index];
            });
            
            // --- REFINED LOGIC for handling multiple mediums and assigning ResourceType ---
            const rawMediumString = rowObject.Medium ? rowObject.Medium.toLowerCase().trim() : '';
            const individualMediums = rawMediumString.split(',').map(m => m.trim()).filter(Boolean);

            let assignedResourceType = mediumCategoryMap['']; // Default to 'Other'
            let foundTypesForThisRow = new Set(); // Keep track of all types found for THIS specific row

            for (const medium of individualMediums) {
                const mappedType = mediumCategoryMap[medium];
                if (mappedType && mappedType !== 'Other' && mappedType !== '') {
                    foundTypesForThisRow.add(mappedType);
                }
            }

            if (foundTypesForThisRow.size > 0) {
                // Apply priority: iterate through our predefined priority list
                for (const priorityType of resourceTypePriority) {
                    if (foundTypesForThisRow.has(priorityType)) {
                        assignedResourceType = priorityType;
                        break; // Assign the highest priority type found and stop
                    }
                }
            }
            rowObject.ResourceType = assignedResourceType;
            // --- END REFINED LOGIC ---
            
            // Handle multiple fields: split the 'Field' string into an array of individual fields
            if (rowObject.Field) {
                rowObject.Field = rowObject.Field.split(',').map(f => f.toLowerCase().trim()).filter(Boolean);
            } else {
                rowObject.Field = []; // Ensure it's an empty array if no fields
            }

            // Detailed debug log for each row's medium processing
            console.groupCollapsed(`Medium processing for row: "${rowObject.Title || 'Untitled'}"`);
            console.log(`Original Medium: "${rowObject.Medium}"`);
            console.log(`Individual mediums parsed: [${individualMediums.map(m => `"${m}"`).join(', ')}]`);
            console.log(`Mapped types found: [${[...foundTypesForThisRow].map(t => `"${t}"`).join(', ')}]`);
            console.log(`Final assigned ResourceType: "${rowObject.ResourceType}"`);
            console.groupEnd();
            
            data.push(rowObject);
        }
        return data;
    }

    // Renders a single resource card
    function renderResourceCard(item) {
        const card = document.createElement('a');
        card.href = item.Link || '#';
        card.target = "_blank";
        card.rel = "noopener noreferrer";
        card.className = 'resource-card';

        const imageUrl = item.ImageLink && item.ImageLink.startsWith('http') ? item.ImageLink : 'https://placehold.co/400x180/e2e8f0/94a3b8?text=No+Image';

        let imageContent;
        if (imageUrl.includes('placehold.co')) {
            imageContent = `<div class="resource-image">No Image Available</div>`;
        } else {
            imageContent = `<img src="${imageUrl}" alt="${item.Title || 'Resource image'}" class="resource-image" onerror="this.onerror=null;this.src='https://placehold.co/400x180/e2e8f0/94a3b8?text=Image+Load+Error';"/>`;
        }

        const mediumTag = item.Medium ? `<span class="tag-badge">${item.Medium}</span>` : '';
        const fieldTagsHtml = item.Field && item.Field.length > 0
            ? item.Field.map(f => `<span class="tag-badge">${f}</span>`).join('')
            : '';

        card.innerHTML = `
            ${imageContent}
            <div class="resource-overlay">
                <h3>${item.Title || 'untitled resource'}</h3>
                <p class="resource-description">${item.Description || 'no description provided.'}</p>
                <div class="tags-container">
                    ${mediumTag}
                    ${fieldTagsHtml}
                </div>
            </div>
        `;
        return card;
    }

    // Displays resources in the container
    function displayResources(resourcesToDisplay) {
        const container = document.getElementById('resources-container');
        container.innerHTML = '';

        if (resourcesToDisplay.length === 0) {
            container.innerHTML = `<p class="loading-message">no resources found matching your current filters. try broadening your search.</p>`;
            return;
        }

        resourcesToDisplay.forEach(item => {
            const card = renderResourceCard(item);
            container.appendChild(card);
        });
    }

    // Dynamically generates filter tags and attaches event listeners
    function renderFilterTags(filterType, containerId, allItems) {
        const container = document.getElementById(containerId);
        container.innerHTML = `<span class="filter-tag all-tag selected" data-filter-type="${filterType}" data-filter-value="all">all</span>`;

        let uniqueItems = new Set();
        if (filterType === 'ResourceType') {
            Object.values(mediumCategoryMap).filter(val => val !== 'Other' && val !== '').forEach(type => uniqueItems.add(type));
        } else if (filterType === 'Field') {
            allItems.forEach(item => {
                if (item.Field && Array.isArray(item.Field)) {
                    item.Field.forEach(field => {
                        if (field.toLowerCase() !== 'all') { // Avoid adding 'all' if it's a data value
                            uniqueItems.add(field);
                        }
                    });
                }
            });
        } else {
            // This case should ideally not be hit with current filter types, but kept for robustness
            allItems.map(item => item[filterType]).filter(Boolean).forEach(val => uniqueItems.add(val));
        }

        // Sort unique items and create tags
        [...uniqueItems].sort().forEach(itemValue => {
            const tag = document.createElement('span');
            tag.className = 'filter-tag';
            tag.textContent = itemValue.toLowerCase();
            tag.dataset.filterType = filterType;
            tag.dataset.filterValue = itemValue.toLowerCase();

            // Check against the correct selected Set
            const selectedSet = filterType === 'ResourceType' ? selectedResourceTypes : selectedField;
            if (selectedSet.has(itemValue.toLowerCase())) {
                tag.classList.add('selected');
            }

            tag.addEventListener('click', handleFilterTagClick);
            container.appendChild(tag);
        });
    }

    // Renders and updates the active filter badges above the results
    function renderActiveFilters() {
        const activeFiltersDisplay = document.getElementById('active-filters-display');
        activeFiltersDisplay.innerHTML = '';

        const appendBadge = (type, value) => {
            const badge = document.createElement('span');
            badge.className = 'active-filter-badge';
            const label = type === 'ResourceType' ? 'type' : 'field'; // Customize label based on filter type
            badge.innerHTML = `<span class="filter-type-label">${label}:</span> ${value} <button class="remove-filter" data-filter-type="${type}" data-filter-value="${value}">&times;</button>`;
            badge.querySelector('.remove-filter').addEventListener('click', (event) => {
                const filterTypeToRemove = event.target.dataset.filterType;
                const filterValueToRemove = event.target.dataset.filterValue;
                
                // Simulate clicking the original filter tag to deselect it
                const originalTag = document.querySelector(`.filter-tag[data-filter-type="${filterTypeToRemove}"][data-filter-value="${filterValueToRemove}"]`);
                if (originalTag) {
                    originalTag.click(); // This will trigger handleFilterTagClick and re-filter
                }
            });
            activeFiltersDisplay.appendChild(badge);
        };

        // Add badges for Resource Types
        if (!selectedResourceTypes.has('all') && selectedResourceTypes.size > 0) {
            selectedResourceTypes.forEach(val => appendBadge('ResourceType', val));
        }

        // Add badges for Fields
        if (!selectedField.has('all') && selectedField.size > 0) {
            selectedField.forEach(val => appendBadge('Field', val));
        }

        // Add search query badge if active
        if (searchQuery.trim() !== '') {
            const searchBadge = document.createElement('span');
            searchBadge.className = 'active-filter-badge';
            searchBadge.innerHTML = `<span class="filter-type-label">search:</span> "${searchQuery}" <button class="remove-filter" data-filter-type="Search" data-filter-value="${searchQuery}">&times;</button>`;
            searchBadge.querySelector('.remove-filter').addEventListener('click', () => {
                searchQuery = '';
                document.getElementById('search-bar').value = '';
                filterAndDisplayResources();
                renderActiveFilters(); // Re-render to remove search badge
            });
            activeFiltersDisplay.appendChild(searchBadge);
        }

        // Show "no filters applied" if nothing is selected and no search query
        if (selectedResourceTypes.has('all') && selectedField.has('all') && searchQuery.trim() === '') {
            activeFiltersDisplay.innerHTML = `<p style="margin:0; color:#888;">no active filters.</p>`;
        }
    }


    // Handles clicks on filter tags (existing logic, with added renderActiveFilters call)
    function handleFilterTagClick(event) {
        const clickedTag = event.target;
        const filterType = clickedTag.dataset.filterType;
        const filterValue = clickedTag.dataset.filterValue.toLowerCase();

        const selectedSet = filterType === 'ResourceType' ? selectedResourceTypes : selectedField;
        const allTagsInGroup = document.querySelectorAll(`.filter-tag[data-filter-type="${filterType}"]`);
        const allTag = document.querySelector(`.filter-tag.all-tag[data-filter-type="${filterType}"]`);

        if (filterValue === 'all') {
            selectedSet.clear();
            selectedSet.add('all');
            allTagsInGroup.forEach(tag => tag.classList.remove('selected'));
            allTag.classList.add('selected');
        } else {
            if (selectedSet.has('all')) {
                selectedSet.delete('all');
                allTag.classList.remove('selected');
            }
            if (selectedSet.has(filterValue)) {
                selectedSet.delete(filterValue);
                clickedTag.classList.remove('selected');
                if (selectedSet.size === 0) {
                    selectedSet.add('all');
                    allTag.classList.add('selected');
                }
            } else {
                selectedSet.add(filterValue);
                clickedTag.classList.add('selected');
            }
        }
        filterAndDisplayResources();
        renderActiveFilters(); // Update active filter display
    }

    // Main function to apply all filters and display results
    function filterAndDisplayResources() {
        let currentFilteredResources = allResources.filter(resource => {
            const resourceResourceType = resource.ResourceType ? resource.ResourceType.toLowerCase() : '';
            const resourceTitle = resource.Title ? resource.Title.toLowerCase() : '';
            const resourceDescription = resource.Description ? resource.Description.toLowerCase() : '';

            // ResourceType filter logic
            const matchesResourceType = selectedResourceTypes.has('all') || selectedResourceTypes.has(resourceResourceType);

            // Field filter logic: Check if ANY selected field is present in the resource's Field array
            const matchesField = selectedField.has('all') ||
                                 (resource.Field && resource.Field.some(field => selectedField.has(field)));

            // Search filter logic
            const matchesSearch = !searchQuery ||
                                  resourceTitle.includes(searchQuery.toLowerCase()) ||
                                  resourceDescription.includes(searchQuery.toLowerCase());

            return matchesResourceType && matchesField && matchesSearch;
        });

        displayResources(currentFilteredResources);
    }

    // --- Initialize Data Loading and Event Listeners ---
    document.addEventListener('DOMContentLoaded', async () => {
        const loadingMessage = document.getElementById('loading-resources');
        const resourcesContainer = document.getElementById('resources-container');
        const searchBar = document.getElementById('search-bar');
        const clearFiltersBtn = document.getElementById('clear-filters-btn');

        try {
            const response = await fetch(GOOGLE_SHEET_RESOURCES_URL);
            if (!response.ok) {
                throw new Error(`HTTP error! Status: ${response.status}. Please ensure the Google Sheet URL is correct and published to web.`);
            }
            const csvText = await response.text();
            allResources = parseCSV(csvText);

            renderFilterTags('ResourceType', 'resource-type-filters', allResources);
            renderFilterTags('Field', 'field-filters', allResources);

            filterAndDisplayResources();
            renderActiveFilters(); // Initial render of active filters

        } catch (error) {
            console.error('Error fetching or processing resources:', error);
            resourcesContainer.innerHTML = `<p class="loading-message error-message">Error loading resources. Please check the console for details and ensure the Google Sheet URL is correct and published.</p>`;
        } finally {
            if (loadingMessage) {
                 loadingMessage.style.display = 'none';
            }
        }

        searchBar.addEventListener('input', (event) => {
            searchQuery = event.target.value;
            filterAndDisplayResources();
            renderActiveFilters(); // Update active filter display
        });

        clearFiltersBtn.addEventListener('click', () => {
            selectedResourceTypes.clear();
            selectedResourceTypes.add('all');
            selectedField.clear();
            selectedField.add('all');
            searchQuery = '';
            document.getElementById('search-bar').value = ''; // Clear search bar input

            document.querySelectorAll('.filter-tag').forEach(tag => tag.classList.remove('selected'));
            document.querySelectorAll('.filter-tag.all-tag').forEach(tag => tag.classList.add('selected'));

            filterAndDisplayResources();
            renderActiveFilters(); // Update active filter display
        });
    });
  </script>
</body>
</html>
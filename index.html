<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Critical Fields</title>
  <link rel="stylesheet" href="styles.css" />
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono&display=swap" rel="stylesheet">
  <style>
    /* Styles specific to index.html sections to complement styles.css */
    /* Adjustments for the hero section's new copy length */
    .hero {
        padding: 4rem 2rem;
        text-align: center;
        max-width: 800px;
        margin: 0 auto;
    }

    .hero .tagline {
        font-size: 1.8rem;
        font-weight: normal;
        text-transform: uppercase;
        margin-bottom: 1.5rem;
        color: var(--color-accent-highlight);
    }

    .hero .intro {
        margin: 1.5rem 0 2.5rem;
        font-size: 1.05rem;
        color: var(--color-text-secondary);
        line-height: 1.7;
        text-align: center;
    }

    .hero .cta {
        display: inline-block;
        padding: 0.6rem 1.2rem;
        border: 1px solid var(--color-accent-highlight);
        background: transparent;
        color: var(--color-accent-highlight);
        text-decoration: none;
        font-size: 1rem;
        text-transform: lowercase;
        transition: all 0.3s ease;
    }
    .hero .cta:hover {
        background-color: var(--color-accent-highlight);
        color: var(--color-main-bg);
    }

    /* --- Platform Features Section Styles (now uses the new general styles) --- */
    /* This main #platform-features section itself will apply common card styles */
    #platform-features {
        padding: 3rem 2rem;
        max-width: 1200px;
        margin: 0 auto;
        background-color: var(--color-card-bg); /* Use card-bg for consistency */
        border: 1px solid var(--color-border-dark); /* Apply card border */
        border-radius: 4px;
        box-shadow: var(--shadow-outset-top), var(--shadow-outset-bottom),
                    4px 4px 0px var(--color-border-dark); /* Apply card shadow */
    }

    /* section titles like "Platform-Wide Features" */
    #platform-features .section-title {
        text-align: center;
        font-size: 2.2rem; /* Consistent with global section title */
        margin: 0 auto 2.5rem; /* Adjust margin */
        color: var(--color-accent-highlight); /* Consistent red for main section title */
        border-bottom: 1px solid var(--color-border-dark);
        padding-bottom: 0.5rem;
        display: block;
        max-width: fit-content;
        text-transform: uppercase;
        letter-spacing: 1px;
    }

    /* H3 titles within homepage content areas */
    .homepage-content-h3 {
        font-size: 1.4rem;
        color: var(--color-text-primary); /* Primary text color for sub-headings */
        margin-top: 0;
        margin-bottom: 1.5rem;
        text-transform: lowercase;
        text-align: center;
        border-bottom: 1px dashed var(--color-border-dark);
        padding-bottom: 0.5rem;
        display: block;
        max-width: fit-content;
        margin-left: auto;
        margin-right: auto;
    }

    .content-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
    }

    /* Homepage two-column layout */
    .homepage-two-column {
        display: flex;
        flex-wrap: wrap;
        gap: 2rem;
        padding: 2rem;
        max-width: 1200px;
        margin: 0 auto;
        align-items: flex-start;
    }
    /* Apply feature-card styling directly to the children divs */
    .homepage-two-column > div {
        flex: 1;
        min-width: 300px;
        background-color: var(--color-card-bg);
        border: 1px solid var(--color-border-dark);
        border-radius: 4px;
        box-shadow: var(--shadow-outset-top), var(--shadow-outset-bottom),
                    4px 4px 0px var(--color-border-dark);
        padding: 1.5rem;
    }

    /* What We're Reading section specific styles */
    #what-we-are-reading-container-homepage .reading-item {
        margin-bottom: 1rem;
        padding-bottom: 1rem;
        border-bottom: 1px dashed var(--color-border-dark);
    }
    #what-we-are-reading-container-homepage .reading-item:last-child {
        border-bottom: none;
        margin-bottom: 0;
        padding-bottom: 0;
    }
    #what-we-are-reading-container-homepage .reading-item a {
        color: var(--color-text-primary);
        text-decoration: none;
        font-weight: 600;
        transition: color 0.2s ease;
    }
    #what-we-are-reading-container-homepage .reading-item a:hover {
        color: var(--color-ui-red-light);
        text-decoration: underline;
    }
    #what-we-are-reading-container-homepage .reading-item p {
        font-size: 0.85rem;
        color: var(--color-text-secondary);
        margin-top: 0.2rem;
    }

    /* Latest Newsletter Section (Full Width) */
    #latest-newsletter-section {
        background-color: var(--color-card-bg);
        border: 1px solid var(--color-border-dark);
        border-radius: 4px;
        box-shadow: var(--shadow-outset-top), var(--shadow-outset-bottom),
                    4px 4px 0px var(--color-border-dark);
        padding: 2rem;
        margin: 3rem auto;
        max-width: 1000px;
        display: flex;
        flex-direction: column;
        align-items: center;
        text-align: center;
    }
    #latest-newsletter-section .newsletter-image {
        max-width: 200px;
        height: auto;
        border-radius: 4px;
        margin-bottom: 1.5rem;
        border: 1px solid var(--color-border-dark);
        box-shadow: 1px 1px 0px var(--color-border-dark);
    }
    #latest-newsletter-section .newsletter-title {
        font-size: 1.5rem;
        color: var(--color-accent-highlight);
        margin-bottom: 0.5rem;
        text-decoration: none;
        transition: color 0.3s ease;
    }
    #latest-newsletter-section .newsletter-title:hover {
        color: var(--color-ui-red-light);
    }
    #latest-newsletter-section .newsletter-subtitle {
        font-size: 1rem;
        color: var(--color-text-secondary);
        margin-bottom: 1.5rem;
    }

    /* How to Use Section */
    #how-to-use-section {
        padding: 3rem 2rem;
        max-width: 1000px;
        margin: 3rem auto;
        background-color: var(--color-card-bg);
        border: 1px solid var(--color-border-dark);
        border-radius: 4px;
        box-shadow: var(--shadow-outset-top), var(--shadow-outset-bottom),
                    4px 4px 0px var(--color-border-dark);
        text-align: center;
    }
    #how-to-use-section ul {
        list-style: none;
        padding: 0;
        margin-top: 1.5rem;
        text-align: left;
        max-width: 800px; /* Made wider */
        margin-left: auto;
        margin-right: auto;
        border: 1px solid var(--color-border-dark);
        padding: 1.5rem;
        background-color: var(--color-secondary-bg);
        border-radius: 4px;
        box-shadow: inset 1px 1px 0px var(--color-border-dark), inset -1px -1px 0px var(--color-border-light);
    }
    #how-to-use-section li {
        margin-bottom: 0.8rem;
        font-size: 1rem;
        color: var(--color-text-primary);
        text-transform: lowercase;
        position: relative;
        padding-left: 1.5em;
        border-bottom: 1px dashed var(--color-border-dark);
        padding-bottom: 0.8rem;
        line-height: 1.8; /* Increased line height */
    }
    #how-to-use-section li:last-child {
        border-bottom: none;
        margin-bottom: 0;
        padding-bottom: 0;
    }
    #how-to-use-section li::before {
        content: '> ';
        color: var(--color-accent-highlight);
        position: absolute;
        left: 0;
        font-weight: bold;
    }
    #how-to-use-section li strong {
        color: var(--color-accent-highlight);
        font-weight: bold;
    }

    /* Responsive adjustments */
    @media (max-width: 768px) {
        .homepage-two-column {
            flex-direction: column;
            padding: 1rem;
            gap: 1rem;
        }
        .homepage-two-column > div {
            padding: 1rem;
            margin: 0 auto;
        }
        #latest-newsletter-section, #how-to-use-section {
            padding: 1.5rem;
            margin: 2rem auto;
        }
    }
  </style>
</head>
<body>
  <header class="site-header">
    <nav class="navbar">
      <h1 class="logo">Critical Fields</h1>
      <ul class="nav-menu">
        <li><a href="index.html">Home</a></li>
        <li class="dropdown">
          <a href="fields.html">Fields</a>
          <ul class="dropdown-menu">
            <li><a href="fields.html?name=heterodox-economics">Heterodox Economics</a></li>
            <li><a href="fields.html?name=architectures-of-power">Architectures of Power</a></li>
            <li><a href="fields.html?name=the-digital-apparatus">The Digital Apparatus</a></li>
            <li><a href="fields.html?name=earth-systems">Earth Systems</a></li>
            <li><a href="fields.html?name=the-social-commons">The Social Commons</a></li>
            <li><a href="fields.html?name=critical-methodologies">Critical Methodologies</a></li>
          </ul>
        </li>
        <li><a href="resources.html">Archive</a></li>
        <li><a href="network.html">Network</a></li>
        <li><a href="about.html">About</a></li>
      </ul>
    </nav>
  </header>

  <main>
    <section class="hero">
      <h2 class="tagline typewriter-text">Critical Fields: A Public Knowledge Project for Critical Thought.</h2>
      <p class="intro">
        We are a decentralized platform built by a network of scholars to map the landscape of critical studies. We believe knowledge should be a commons: a space for intentional learning, collective synthesis, and open exchange. Explore our Archive of essential resources, delve into curated Fields of inquiry, and contribute to our shared learning index.
      </p>
      <a href="fields.html" class="cta">enter the fields</a>
    </section>

    <!-- Unified section for "What We're Reading" and "Latest Newsletter" side-by-side -->
    <section id="platform-features">
      <h2 class="section-title">Platform-Wide Features</h2>

      <div class="homepage-two-column">
          <!-- What We're Reading Section -->
          <div id="what-we-are-reading-homepage">
              <h3 class="homepage-content-h3">Chief Editors’ "What We're Reading"</h3>
              <div id="what-we-are-reading-container-homepage">
                  <p class="loading-message" id="what-we-are-reading-loading-homepage">
                      <div class="loader"></div>
                      loading selections...
                  </p>
              </div>
          </div>

          <!-- Latest Newsletter Section (now beside "What We're Reading") -->
          <div id="latest-newsletter-section">
              <h3 class="homepage-content-h3">Latest Weekly Newsletter</h3>
              <div id="latest-newsletter-container">
                  <p class="loading-message" id="latest-newsletter-loading">
                      <div class="loader"></div>
                      loading newsletter...
                  </p>
              </div>
          </div>
      </div>
    </section>

    <!-- How to Use Website Section (Full Width) -->
    <section id="how-to-use-section">
        <h2 class="homepage-content-h3">How to Use This Site</h2>
        <p>Critical Fields is designed to be an interactive digital library and archive. Here’s a brief guide:</p>
        <ul>
            <li><strong>The Archive:</strong> Dive into our comprehensive, user-fed repository of critical resources. Use the advanced filters and search to find exactly what you need. Hover over items to read descriptions.</li>
            <li><strong>Fields:</strong> Explore curated, interdisciplinary lenses on specific critical conversations. Each field offers a focused collection of relevant archive content, essays, editor selections, and more.</li>
            <li><strong>Contribute:</strong> We believe in a knowledge commons. If you have a resource, insight, or analysis that aligns with our mission, we invite you to contribute and help build this collective project.</li>
        </ul>
        <p>This platform is a living project, growing and evolving with the contributions of its community.</p>
    </section>

    <section id="community-signup">
      <h2 class="section-title">Join Our Network</h2>
      <p>Become part of our growing community of thinkers and contributors. Receive updates, participate in discussions, and shape the future of critical learning.</p>
      <a href="#" class="cta">Sign Up Now</a> <!-- Link to actual signup form when ready -->
    </section>
  </main>

  <footer class="site-footer">
    <p>&copy; 2025 Critical Fields.</p>
  </footer>

  <script>
    // --- Configuration for Homepage Dynamic Content ---
    const MAIN_ARCHIVE_SHEET_URL = 'https://docs.google.com/sheets/d/e/2PACX-1vSdn5xz0N63Dzl0n7PRGNTBLk5RkcddzJQ4MoObZJFNeE-9qUbYkdO49bgGlwUyJnby0innAVYaVR7n/pub?output=csv';

    // Helper function to parse CSV data (reused across site)
    function parseCSV(csvText) {
        const lines = csvText.trim().split('\n');
        if (lines.length === 0) return [];

        const parseLine = (line) => {
            const values = [];
            let inQuote = false;
            let currentVal = '';
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                if (char === '"') {
                    inQuote = !inQuote;
                    if (!inQuote && i < line.length - 1 && line[i+1] === '"') {
                        currentVal += '"';
                        i++;
                    }
                } else if (char === ',' && !inQuote) {
                    values.push(currentVal.trim());
                    currentVal = '';
                } else {
                    currentVal += char;
                }
            }
            values.push(currentVal.trim());
            return values;
        };

        const headers = parseLine(lines[0]).map(header => {
            return header.trim().replace(/[^a-zA-Z0-9]/g, '');
        });
        
        const data = [];
        for (let i = 1; i < lines.length; i++) {
            const values = parseLine(lines[i]);
            if (values.length !== headers.length) {
                console.warn(`Skipping malformed row (header/value count mismatch): ${lines[i]}`);
                continue;
            }
            const rowObject = {};
            headers.forEach((header, index) => {
                rowObject[header] = values[index];
            });
            data.push(rowObject);
        }
        return data;
    }

    // Generic function to fetch and display data, now with added filtering capability
    async function fetchDataAndDisplay(url, targetContainerId, renderFunction, limit = 3, filterCriterion = null) {
        const loadingElement = document.getElementById(`${targetContainerId.replace('-container', '')}-loading`);
        const container = document.getElementById(targetContainerId);
        
        if (loadingElement) {
            loadingElement.innerHTML = '<div class="loader"></div>' + (loadingElement.dataset.originalText || loadingElement.textContent || 'loading...'); // Preserve original text
            loadingElement.dataset.originalText = loadingElement.dataset.originalText || loadingElement.textContent; // Store original text
            loadingElement.style.display = 'block';
        }
        container.innerHTML = ''; // Clear previous content / placeholders

        try {
            const response = await fetch(url);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const csvText = await response.text();
            let data = parseCSV(csvText);

            // Apply filter criterion if provided
            if (filterCriterion) {
                data = data.filter(item => {
                    const itemValue = item[filterCriterion.column];
                    // Ensure robust comparison for comma-separated values in the target column
                    if (itemValue) {
                        const valuesInCell = itemValue.toLowerCase().split(',').map(v => v.trim());
                        return valuesInCell.includes(filterCriterion.value.toLowerCase());
                    }
                    return false;
                });
            }

            if (data.length === 0) {
                container.innerHTML = `<p class="loading-message">no content available yet.</p>`;
                return;
            }

            const itemsToShow = data.slice(0, limit); 

            itemsToShow.forEach(item => {
                const card = renderFunction(item);
                if (card) {
                    container.appendChild(card);
                }
            });
        } catch (error) {
            console.error(`Error fetching or rendering data for ${targetContainerId}:`, error);
            container.innerHTML = `<p class="loading-message error-message">failed to load content. please check the sheet URL.</p>`;
        } finally {
            if (loadingElement) {
                loadingElement.style.display = 'none';
            }
        }
    }

    // --- Render Functions for Homepage Sections ---

    function renderReadingCard(item) {
        const div = document.createElement('div');
        div.className = 'reading-item';
        div.innerHTML = `
            <a href="${item.Link || '#'}" target="_blank" rel="noopener noreferrer">${item.Title || 'untitled selection'}</a>
            <p>${item.Description || 'no description provided.'}</p>
            <p style="font-size: 0.75rem; color: var(--color-text-secondary); opacity: 0.7;">${item.Medium || 'item'} by ${item.Author || 'the editors'}</p>
        `;
        return div;
    }

    function renderNewsletterCard(item) {
        const div = document.createElement('div');
        div.innerHTML = `
            ${item.ImageLink && item.ImageLink.startsWith('http') ? `<img src="${item.ImageLink}" alt="${item.Title || 'Newsletter image'}" class="newsletter-image" onerror="this.style.display='none';">` : ''}
            <a href="${item.Link || '#'}" target="_blank" rel="noopener noreferrer" class="newsletter-title">${item.Title || 'untitled newsletter'}</a>
            <p class="newsletter-subtitle">${item.Description || 'no summary provided.'}</p>
            <p style="font-size: 0.8rem; color: var(--color-text-secondary); opacity: 0.7;">published ${item.Date || 'n.d.'}</p>
        `;
        return div;
    }

    // --- Initialize Data Loading on Page Load ---
    document.addEventListener('DOMContentLoaded', () => {
        // What We're Reading section
        fetchDataAndDisplay(MAIN_ARCHIVE_SHEET_URL, 'what-we-are-reading-container-homepage', renderReadingCard, 5, { column: 'Medium', value: 'Editor Selection' });

        // Latest Newsletter
        fetchDataAndDisplay(MAIN_ARCHIVE_SHEET_URL, 'latest-newsletter-container', renderNewsletterCard, 1, { column: 'Medium', value: 'Newsletter' });
    });
  </script>
</body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Critical Fields</title>
  <link rel="stylesheet" href="styles.css" />
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono&display=swap" rel="stylesheet">
  <style>
    /* Styles specific to index.html sections to complement styles.css */
    /* Adjustments for the hero section's new copy length */
    .hero {
        padding: 2rem 2rem 1.5rem; /* Reduced padding */
        text-align: center; /* Default center, overridden by flex below */
        max-width: 1200px; /* Wider for two-column layout */
        margin: 0 auto;
        border-bottom: 1px solid var(--color-border-dark); /* Keep separator */
        padding-bottom: 1.5rem;
        display: flex; /* Enable flexbox for two columns */
        flex-wrap: wrap; /* Allow wrapping on smaller screens */
        gap: 2rem; /* Space between columns */
        align-items: flex-start; /* Align columns to the top */
    }

    .hero .tagline {
        font-size: 1.8rem;
        font-weight: normal;
        text-transform: uppercase;
        margin-bottom: 1rem; /* Reduced margin */
        color: var(--color-accent-highlight);
    }

    .hero .intro { /* This class is now used by the blurb section below */
        margin: 1rem 0 1.5rem; /* Reduced margins */
        font-size: 1.05rem;
        color: var(--color-text-secondary);
        line-height: 1.7;
        text-align: left;
    }

    .hero .cta { /* This will now be used by the blurb section below */
        display: inline-block;
        padding: 0.6rem 1.2rem;
        border: 1px solid var(--color-accent-highlight);
        background: transparent;
        color: var(--color-accent-highlight);
        text-decoration: none;
        font-size: 1rem;
        text-transform: lowercase;
        transition: all 0.3s ease;
    }
    .hero .cta:hover {
        background-color: var(--color-accent-highlight);
        color: var(--color-main-bg);
    }

    /* --- Marquee/Scrolling Text for Tagline --- */
    .marquee-container {
      overflow: hidden; /* Hide overflowing text */
      white-space: nowrap; /* Keep text on a single line */
      box-sizing: border-box;
      width: 100%; /* Ensure it spans the container */
      padding: 0.5rem 0; /* Vertical padding for the bar */
      background-color: var(--color-secondary-bg); /* Background for the bar */
      border: 1px solid var(--color-border-dark);
      border-radius: 4px;
      box-shadow: inset 1px 1px 0px var(--color-border-dark), inset -1px -1px 0px var(--color-border-light);
      margin-bottom: 1.5rem; /* Space below the marquee bar */
    }

    .marquee-text {
      display: inline-block; /* Essential for animation */
      padding-left: 100%; /* Start off-screen to the right */
      animation: marquee 15s linear infinite; /* Adjust duration as needed */
      font-size: 1.2rem; /* Smaller font size for marquee */
      color: var(--color-accent-highlight); /* Red for marquee text */
      text-transform: uppercase;
      letter-spacing: 0.05em;
      line-height: 1; /* Tighter line height */
    }

    @keyframes marquee {
      0% { transform: translateX(0%); }
      100% { transform: translateX(-100%); }
    }


    /* --- Main Content Sections (Newsletter, How-to, Join) --- */
    .homepage-content-section {
        padding: 2rem 2rem;
        max-width: 1000px; /* Constrain width for single column sections */
        margin: 2rem auto;
        background-color: var(--color-card-bg);
        border: 1px solid var(--color-border-dark);
        border-radius: 4px;
        box-shadow: var(--shadow-outset-top), var(--shadow-outset-bottom),
                    4px 4px 0px var(--color-border-dark);
        text-align: center;
    }

    /* Section titles within homepage content areas */
    .homepage-content-section .section-title {
        margin-top: 0;
        margin-bottom: 2.5rem;
    }

    /* H3 titles within homepage content areas */
    .homepage-content-h3 {
        font-size: 1.4rem;
        color: var(--color-text-primary);
        margin-top: 0;
        margin-bottom: 1rem;
        text-transform: lowercase;
        text-align: center;
        border-bottom: 1px dashed var(--color-border-dark);
        padding-bottom: 0.5rem;
        display: block;
        max-width: fit-content;
        margin-left: auto;
        margin-right: auto;
    }

    /* What We're Reading Rotator specific styles (now in Hero Right Column) */
    #editors-picks-rotator-section { /* This section now wraps the rotator in the right column */
        background-color: var(--color-card-bg);
        border: 1px solid var(--color-border-dark);
        border-radius: 4px;
        box-shadow: var(--shadow-outset-top), var(--shadow-outset-bottom),
                    4px 4px 0px var(--color-border-dark);
        padding: 1.5rem; /* Padding inside the right column box */
        text-align: center;
        width: 100%; /* Ensure it fills its flex column */
        box-sizing: border-box;
        /* No margin-top/bottom here, handled by gap in .hero */
    }

    .rotator-container { /* Common style for rotators */
        position: relative;
        overflow: hidden;
        width: 100%;
        min-height: 350px; /* Adjusted min-height for prominent image */
        margin: 0 auto;
        border: 1px solid var(--color-border-light);
        border-radius: 4px;
        box-shadow: inset 1px 1px 0px var(--color-border-dark), inset -1px -1px 0px var(--color-border-light);
    }
    .rotator-slides-wrapper {
        display: flex;
        transition: transform 0.5s ease-in-out;
        height: 100%;
    }
    .rotator-slide {
        flex: 0 0 100%;
        width: 100%;
        box-sizing: border-box;
        display: flex;
        flex-direction: column;
        justify-content: flex-end; /* Align content to bottom */
        align-items: center;
        position: relative;
        min-height: 350px; /* Match container height */
        background-size: cover;
        background-position: center;
        border-radius: 4px;
        color: white; /* Default text color for overlay */
    }
    .rotator-slide .overlay-content {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        background: linear-gradient(to top, rgba(0,0,0,0.9), rgba(0,0,0,0.2)); /* Stronger gradient for readability */
        padding: 1.5rem;
        text-align: center;
        width: 100%;
        box-sizing: border-box;
    }
    .rotator-slide h4 {
        margin: 0;
        font-size: 1.5rem;
        color: var(--color-accent-highlight);
        text-transform: uppercase;
        line-height: 1.2;
        margin-bottom: 0.5rem;
    }
    .rotator-slide p {
        margin: 0;
        font-size: 1rem;
        color: var(--color-text-primary);
        line-height: 1.6;
        opacity: 0.9;
    }
    .rotator-slide .source-meta {
        font-size: 0.85rem;
        color: var(--color-text-secondary);
        opacity: 0.8;
        margin-top: 0.8rem;
    }

    .rotator-pagination-dots {
        text-align: center;
        margin-top: 1rem;
    }
    .rotator-dot {
        height: 8px;
        width: 8px;
        margin: 0 4px;
        background-color: var(--color-border-dark);
        border-radius: 50%;
        display: inline-block;
        cursor: pointer;
        transition: background-color 0.3s ease, transform 0.2s ease;
    }
    .rotator-dot.active {
        background-color: var(--color-accent-highlight);
        transform: scale(1.2);
    }
    .rotator-arrow {
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
        background: rgba(0,0,0,0.6);
        color: white;
        border: none;
        padding: 0.3rem 0.6rem;
        cursor: pointer;
        font-size: 1.2rem;
        line-height: 1;
        border-radius: 3px;
        z-index: 10;
        opacity: 0.7;
        transition: opacity 0.2s ease;
    }
    .rotator-arrow:hover {
        opacity: 1;
    }
    .rotator-arrow.prev {
        left: 5px;
    }
    .rotator-arrow.next {
        right: 5px;
    }


    /* Newsletter Section */
    #latest-newsletter-section {
        padding: 2rem;
        max-width: 1000px; /* Constrain width */
        margin: 2rem auto;
        background-color: var(--color-card-bg);
        border: 1px solid var(--color-border-dark);
        border-radius: 4px;
        box-shadow: var(--shadow-outset-top), var(--shadow-outset-bottom),
                    4px 4px 0px var(--color-border-dark);
        text-align: center;
        display: flex; /* Make it a flex container */
        flex-direction: row; /* Default to row */
        align-items: center; /* Vertically center items */
        gap: 1.5rem; /* Space between image and text */
    }
    #latest-newsletter-section .newsletter-image-wrapper { /* New wrapper for image */
        flex-shrink: 0; /* Prevent image from shrinking */
        width: 250px; /* Fixed width for image container */
        height: 150px; /* Fixed height for image container */
        overflow: hidden;
        border-radius: 4px;
        border: 1px solid var(--color-border-dark);
        box-shadow: 1px 1px 0px var(--color-border-dark);
        background-color: var(--color-secondary-bg); /* Placeholder background */
        display: flex; /* For centering placeholder text */
        justify-content: center;
        align-items: center;
        color: var(--color-text-secondary);
    }
    #latest-newsletter-section .newsletter-image {
        width: 100%;
        height: 100%;
        object-fit: cover; /* Cover to fill the fixed dimensions */
        border-radius: 0; /* No border-radius here, applied to wrapper */
        border: none; /* No border here */
        box-shadow: none; /* No shadow here */
    }
    #latest-newsletter-section .newsletter-content { /* New wrapper for text content */
        flex-grow: 1; /* Allow text to take remaining space */
        text-align: left; /* Align text left */
    }
    #latest-newsletter-section .newsletter-title {
        font-size: 1.5rem;
        color: var(--color-accent-highlight);
        margin-bottom: 0.5rem;
        text-decoration: none;
        transition: color 0.3s ease;
    }
    #latest-newsletter-section .newsletter-title:hover {
        color: var(--color-ui-red-light);
    }
    #latest-newsletter-section .newsletter-subtitle {
        font-size: 1rem;
        color: var(--color-text-secondary);
        margin-bottom: 0.5rem; /* Reduced margin */
    }
    #latest-newsletter-section p { /* General paragraph in newsletter content */
        margin: 0; /* Reset default margin */
    }


    /* Blurb Section */
    #blurb-section .homepage-content-h3 {
        margin-top: 0;
    }
    .intro-blurb {
        margin: 1.5rem auto 1.5rem;
        font-size: 1.05rem;
        color: var(--color-text-secondary);
        line-height: 1.7;
        text-align: left;
    }
    #blurb-section .cta {
        margin-top: 0;
    }


    /* How to Use Section */
    #how-to-use-section {
        padding: 2rem 2rem;
        max-width: 1000px;
        margin: 2rem auto;
        background-color: var(--color-card-bg);
        border: 1px solid var(--color-border-dark);
        border-radius: 4px;
        box-shadow: var(--shadow-outset-top), var(--shadow-outset-bottom),
                    4px 4px 0px var(--color-border-dark);
        text-align: center;
    }
    #how-to-use-section ul {
        list-style: none;
        padding: 0;
        margin-top: 1.5rem;
        text-align: left;
        max-width: 800px;
        margin-left: auto;
        margin-right: auto;
        border: 1px solid var(--color-border-dark);
        padding: 1.5rem;
        background-color: var(--color-secondary-bg);
        border-radius: 4px;
        box-shadow: inset 1px 1px 0px var(--color-border-dark), inset -1px -1px 0px var(--color-border-light);
    }
    #how-to-use-section li {
        margin-bottom: 0.8rem;
        font-size: 1rem;
        color: var(--color-text-primary);
        text-transform: lowercase;
        position: relative;
        padding-left: 1.5em;
        border-bottom: 1px dashed var(--color-border-dark);
        padding-bottom: 0.8rem;
        line-height: 1.8;
    }
    #how-to-use-section li:last-child {
        border-bottom: none;
        margin-bottom: 0;
        padding-bottom: 0;
    }
    #how-to-use-section li::before {
        content: '> ';
        color: var(--color-accent-highlight);
        position: absolute;
        left: 0;
        font-weight: bold;
    }
    #how-to-use-section li strong {
        color: var(--color-accent-highlight);
        font-weight: bold;
    }

    /* Community Signup Section */
    #community-signup {
        padding: 2rem 2rem;
        max-width: 1000px;
        margin: 2rem auto;
        background-color: var(--color-card-bg);
        border: 1px solid var(--color-border-dark);
        border-radius: 4px;
        box-shadow: var(--shadow-outset-top), var(--shadow-outset-bottom),
                    4px 4px 0px var(--color-border-dark);
        text-align: center;
    }
    #community-signup .section-title {
        margin-top: 0;
    }
    #community-signup p {
        font-size: 1.1rem;
        color: var(--color-text-secondary);
        max-width: 600px;
        margin: 0 auto 1.5rem;
    }
    #community-signup .cta {
        margin-top: 0;
    }

    /* New Subscribe Section */
    #subscribe-section {
        background-color: var(--color-secondary-bg);
        border: 1px solid var(--color-border-dark);
        border-radius: 4px;
        box-shadow: var(--shadow-inset-top), var(--shadow-inset-bottom);
        padding: 2.5rem 2rem;
        max-width: 800px;
        margin: 3rem auto;
        text-align: center;
    }
    #subscribe-section h3 {
        font-size: 1.5rem;
        color: var(--color-text-primary);
        margin-bottom: 1.5rem;
        text-transform: lowercase;
    }
    #subscribe-section .subscribe-form {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        gap: 1rem;
        max-width: 500px;
        margin: 0 auto;
    }
    #subscribe-section input[type="email"] {
        flex-grow: 1;
        min-width: 200px;
        padding: 0.8rem 1rem;
        border: 1px solid var(--color-border-dark);
        border-radius: 4px;
        background-color: var(--color-card-bg);
        color: var(--color-text-primary);
        font-family: 'IBM Plex Mono', monospace;
        font-size: 1rem;
        box-shadow: inset 1px 1px 0px var(--color-border-dark), inset -1px -1px 0px var(--color-border-light);
    }
    #subscribe-section button {
        padding: 0.8rem 1.5rem;
        background-color: var(--color-text-primary);
        color: var(--color-main-bg);
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-family: 'IBM Plex Mono', monospace;
        font-size: 1rem;
        font-weight: 600;
        text-transform: uppercase;
        box-shadow: var(--shadow-outset-top), var(--shadow-outset-bottom);
        transition: all 0.1s ease-out;
    }
    #subscribe-section button:hover {
        background-color: var(--color-text-secondary);
        box-shadow: var(--shadow-outset-top), var(--shadow-outset-bottom);
    }
    #subscribe-section button:active {
        transform: translate(1px, 1px);
        box-shadow: var(--shadow-inset-top), var(--shadow-inset-bottom);
    }


    /* Footer */
    .site-footer {
      text-align: center;
      font-size: 0.85rem;
      padding: 1.5rem;
      color: var(--color-text-secondary);
      border-top: 1px solid var(--color-border-dark);
      background-color: var(--color-secondary-bg);
      margin-top: 4rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      max-width: 1200px;
      margin-left: auto;
      margin-right: auto;
    }
    .site-footer p {
        margin: 0;
    }
    .footer-links {
        display: flex;
        gap: 1.5rem;
        list-style: none;
        padding: 0;
        margin: 0;
    }
    .footer-links a {
        color: var(--color-text-secondary);
        text-decoration: none;
        text-transform: lowercase;
        transition: color 0.2s ease;
    }
    .footer-links a:hover {
        color: var(--color-ui-red);
    }
    .social-icons {
        display: flex;
        gap: 1rem;
    }
    .social-icons a {
        color: var(--color-text-secondary);
        font-size: 1.5rem;
        text-decoration: none;
        transition: color 0.2s ease;
    }
    .social-icons a:hover {
        color: var(--color-ui-red);
    }


    /* Responsive adjustments */
    @media (max-width: 768px) {
        .hero {
            flex-direction: column;
            padding: 2rem 1rem 1rem;
            gap: 1.5rem;
        }
        .hero .hero-left-column,
        .hero .hero-right-column {
            padding: 1rem;
            min-width: unset;
            text-align: center;
        }
        .hero .hero-left-column .tagline {
            text-align: center;
        }
        .hero .hero-left-column .hero-description {
            text-align: center;
        }
        .spotlight-title {
            font-size: 1.4rem;
            margin-bottom: 1rem;
        }
        .rotator-container {
            min-height: 280px;
        }
        .rotator-slide h4 {
            font-size: 1.5rem;
        }
        .rotator-slide p {
            font-size: 0.9rem;
        }
        .rotator-slide .source-meta {
            font-size: 0.8rem;
        }

        .homepage-content-section {
            padding: 1.5rem 1rem;
            margin: 1.5rem auto;
        }
        #latest-newsletter-section {
            flex-direction: column; /* Stack image and text on mobile */
            align-items: center;
            padding: 1.5rem 1rem;
            gap: 1rem;
        }
        #latest-newsletter-section .newsletter-image-wrapper {
            width: 100%; /* Full width on mobile */
            height: 180px; /* Adjust height for mobile */
        }
        #latest-newsletter-section .newsletter-content {
            text-align: center; /* Center text on mobile */
        }
        #latest-newsletter-section .newsletter-title {
            font-size: 1.3rem;
        }
        #latest-newsletter-section .newsletter-subtitle {
            font-size: 0.9rem;
        }
        #how-to-use-section ul {
            padding: 1rem;
        }
        #how-to-use-section li {
            font-size: 0.9rem;
            line-height: 1.6;
        }

        #subscribe-section {
            padding: 1.5rem 1rem;
            margin: 2rem auto;
        }
        #subscribe-section h3 {
            font-size: 1.3rem;
            margin-bottom: 1rem;
        }
        #subscribe-section .subscribe-form {
            flex-direction: column;
            gap: 0.8rem;
        }
        #subscribe-section input[type="email"],
        #subscribe-section button {
            width: 100%;
            max-width: unset;
        }

        .site-footer {
            flex-direction: column;
            gap: 1rem;
            padding: 1rem;
        }
        .footer-links, .social-icons {
            justify-content: center;
            width: 100%;
        }
    }
  </style>
</head>
<body>
  <header class="site-header">
    <nav class="navbar">
      <h1 class="logo">Critical Fields</h1>
      <ul class="nav-menu">
        <li><a href="index.html">Home</a></li>
        <li class="dropdown">
          <a href="fields.html">Fields</a>
          <ul class="dropdown-menu">
            <li><a href="fields.html?name=heterodox-economics">Heterodox Economics</a></li>
            <li><a href="fields.html?name=architectures-of-power">Architectures of Power</a></li>
            <li><a href="fields.html?name=the-digital-apparatus">The Digital Apparatus</a></li>
            <li><a href="fields.html?name=earth-systems">Earth Systems</a></li>
            <li><a href="fields.html?name=the-social-commons">The Social Commons</a></li>
            <li><a href="fields.html?name=critical-methodologies">Critical Methodologies</a></li>
          </ul>
        </li>
        <li><a href="resources.html">Archive</a></li>
        <li><a href="network.html">Network</a></li>
        <li><a href="about.html">About</a></li>
      </ul>
    </nav>
  </header>

  <main>
    <!-- Main Hero Section - Two Columns: Blurb & Editor's Picks Rotator -->
    <section class="hero">
        <div class="hero-left-column">
            <div class="marquee-container">
                <h2 class="tagline marquee-text">A Public Knowledge Project for Critical Thought.</h2>
            </div>
            <p class="hero-description">
              Each field curated by Critical Fields aims to explore a topic through a lens. This list brings a weekly mix of resources from each field of study to create a comprehensive understanding of all forces shaping our world today.
            </p>
            <a href="fields.html" class="cta">enter the fields</a>
        </div>

        <div class="hero-right-column">
            <h3 class="homepage-content-h3">Editor's Picks</h3>
            <div id="editors-picks-rotator-container" class="rotator-container">
                <p class="loading-message" id="editors-picks-loading">
                    <div class="loader"></div>
                    loading editor's picks...
                </p>
            </div>
            <div id="editors-picks-pagination-dots" class="rotator-pagination-dots"></div>
        </div>
    </section>

    <!-- Latest Newsletter Section (Full Width) -->
    <section id="latest-newsletter-section" class="homepage-content-section">
        <h2 class="section-title">Latest Weekly Newsletter</h2>
        <div id="latest-newsletter-container">
            <p class="loading-message" id="latest-newsletter-loading">
                <div class="loader"></div>
                loading newsletter...
            </p>
        </div>
    </section>

    <!-- New Subscribe Section -->
    <section id="subscribe-section">
        <h3>Subscribe to our Newsletters</h3>
        <div class="subscribe-form">
            <input type="email" placeholder="enter your email" aria-label="Enter your email for newsletter subscription">
            <button type="submit">subscribe now</button>
        </div>
    </section>
  </main>

  <footer class="site-footer">
    <ul class="footer-links">
        <li><a href="#">About us</a></li>
        <li><a href="#">Contribute</a></li>
    </ul>
    <p>&copy; 2025 Critical Fields.</p>
    <div class="social-icons">
        <a href="#" aria-label="Instagram"><i class="fab fa-instagram"></i></a>
        <a href="#" aria-label="YouTube"><i class="fab fa-youtube"></i></a>
    </div>
  </footer>

  <script>
    // --- Configuration for Homepage Dynamic Content ---
    const GOOGLE_SHEET_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRBl_Sy0Aw_idmkwuQSGVNloQj4PxOKr2J6d_4YDibJuOppgndtfFpH1HGgkecJR1M6LmDFsezIfaiC/pub?output=csv';
    const MAIN_ARCHIVE_SHEET_URL = GOOGLE_SHEET_CSV_URL;

    // Load Font Awesome for social icons
    const fontAwesomeScript = document.createElement('script');
    fontAwesomeScript.src = 'https://kit.fontawesome.com/a076d05399.js'; // Replace with your Font Awesome Kit URL if you have one
    fontAwesomeScript.crossOrigin = 'anonymous';
    document.head.appendChild(fontAwesomeScript);


    // Helper function to parse CSV data (reused across site)
    function parseCSV(csvText) {
        const lines = csvText.trim().split('\n');
        if (lines.length === 0) return [];

        const parseLine = (line) => {
            const values = [];
            let inQuote = false;
            let currentVal = '';
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                if (char === '"') {
                    inQuote = !inQuote;
                    if (!inQuote && i < line.length - 1 && line[i+1] === '"') {
                        currentVal += '"';
                        i++;
                    }
                } else if (char === ',' && !inQuote) {
                    values.push(currentVal.trim());
                    currentVal = '';
                } else {
                    currentVal += char;
                }
            }
            values.push(currentVal.trim());
            return values;
        };

        const headers = parseLine(lines[0]).map(header => {
            return header.trim().replace(/[^a-zA-Z0-9]/g, '');
        });
        
        const data = [];
        for (let i = 1; i < lines.length; i++) {
            const values = parseLine(lines[i]);
            if (values.length !== headers.length) {
                console.warn(`Skipping malformed row (header/value count mismatch): ${lines[i]}`);
                continue;
            }
            const rowObject = {};
            headers.forEach((header, index) => {
                rowObject[header] = values[index] ? values[index].toLowerCase().trim() : '';
            });
            data.push(rowObject);
        }
        return data;
    }

    // Generic function to fetch and display data, now with added filtering capability
    async function fetchDataAndDisplay(url, targetContainerId, renderFunction, limit = 3, filterCriterion = null) {
        const loadingElement = document.getElementById(`${targetContainerId.replace('-container', '')}-loading`);
        const container = document.getElementById(targetContainerId);
        
        if (loadingElement) {
            if (!loadingElement.dataset.originalText) {
                loadingElement.dataset.originalText = loadingElement.innerHTML;
            }
            loadingElement.innerHTML = '<div class="loader"></div>' + loadingElement.dataset.originalText;
            loadingElement.style.display = 'block';
        }
        container.innerHTML = '';

        try {
            const response = await fetch(url);
            if (!response.ok) {
                throw new Error(`HTTP error! Status: ${response.status}`);
            }
            const csvText = await response.text();
            let data = parseCSV(csvText);

            if (filterCriterion) {
                data = data.filter(item => {
                    const itemValue = item[filterCriterion.column];
                    if (itemValue) {
                        const valuesInCell = itemValue.toLowerCase().split(',').map(v => v.trim());
                        return valuesInCell.includes(filterCriterion.value.toLowerCase());
                    }
                    return false;
                });
            }

            if (data.length === 0) {
                container.innerHTML = `<p class="loading-message">no content available yet.</p>`;
                return;
            }

            const itemsToShow = data.slice(0, limit); 

            if (targetContainerId === 'editors-picks-rotator-container') {
                editorsPicksArticles = itemsToShow;
                renderEditorsPicksRotator();
            } else {
                itemsToShow.forEach(item => {
                    const card = renderFunction(item);
                    if (card) {
                        container.appendChild(card);
                    }
                });
            }
        } catch (error) {
            console.error(`Error fetching or rendering data for ${targetContainerId}:`, error);
            container.innerHTML = `<p class="loading-message error-message">failed to load content. please check the sheet URL.</p>`;
        } finally {
            if (loadingElement) {
                loadingElement.style.display = 'none';
            }
        }
    }

    // --- Rotator Variables for "Editor's Picks" ---
    let editorsPicksArticles = [];
    let currentEditorsPicksIndex = 0;
    let editorsPicksIntervalId;
    const EDITORS_PICKS_ROTATION_INTERVAL = 8000;

    // --- Rotator Functions for "Editor's Picks" ---
    function renderEditorsPicksRotator() {
        const rotatorContainer = document.getElementById('editors-picks-rotator-container');
        const dotsContainer = document.getElementById('editors-picks-pagination-dots');
        rotatorContainer.innerHTML = '';
        dotsContainer.innerHTML = '';

        if (editorsPicksArticles.length === 0) {
            rotatorContainer.innerHTML = `<p class="loading-message">no editor's picks available yet.</p>`;
            return;
        }

        const slidesWrapper = document.createElement('div');
        slidesWrapper.className = 'rotator-slides-wrapper';
        rotatorContainer.appendChild(slidesWrapper);

        editorsPicksArticles.forEach((article, index) => {
            const slide = document.createElement('a');
            slide.href = article.Link || '#';
            slide.target = '_blank';
            slide.rel = 'noopener noreferrer';
            slide.className = 'rotator-slide';
            
            const imageUrl = article.ImageLink && article.ImageLink.startsWith('http') ? article.ImageLink : '';
            if (imageUrl) {
                slide.style.backgroundImage = `url('${imageUrl}')`;
            } else {
                slide.style.backgroundColor = 'var(--color-secondary-bg)';
                slide.style.backgroundImage = 'none';
            }

            slide.innerHTML = `
                <div class="overlay-content">
                    <h4>${article.Title || 'untitled pick'}</h4>
                    <p>${article.Description || 'no description provided.'}</p>
                    <div class="source-meta">${article.Medium || 'item'} by ${article.Author || 'the editors'} &mdash; ${article.Date || 'n.d.'}</div>
                </div>
            `;
            slidesWrapper.appendChild(slide);

            const dot = document.createElement('span');
            dot.className = 'rotator-dot';
            dot.dataset.index = index;
            dot.addEventListener('click', () => {
                stopEditorsPicksRotator();
                showEditorsPicksSlide(index);
                startEditorsPicksRotator();
            });
            dotsContainer.appendChild(dot);
        });

        const prevArrow = document.createElement('button');
        prevArrow.className = 'rotator-arrow prev';
        prevArrow.innerHTML = '&lsaquo;';
        prevArrow.addEventListener('click', () => {
            stopEditorsPicksRotator();
            showEditorsPicksSlide(currentEditorsPicksIndex - 1);
            startEditorsPicksRotator();
        });
        rotatorContainer.appendChild(prevArrow);

        const nextArrow = document.createElement('button');
        nextArrow.className = 'rotator-arrow next';
        nextArrow.innerHTML = '&rsaquo;';
        nextArrow.addEventListener('click', () => {
            stopEditorsPicksRotator();
            showEditorsPicksSlide(currentEditorsPicksIndex + 1);
            startEditorsPicksRotator();
        });
        rotatorContainer.appendChild(nextArrow);

        showEditorsPicksSlide(currentEditorsPicksIndex);
        startEditorsPicksRotator();
    }

    function showEditorsPicksSlide(index) {
        const slidesWrapper = document.querySelector('#editors-picks-rotator-container .rotator-slides-wrapper');
        const dots = document.querySelectorAll('#editors-picks-pagination-dots .rotator-dot');

        if (!slidesWrapper || slidesWrapper.children.length === 0) return;

        if (index >= editorsPicksArticles.length) {
            currentEditorsPicksIndex = 0;
        } else if (index < 0) {
            currentEditorsPicksIndex = editorsPicksArticles.length - 1;
        } else {
            currentEditorsPicksIndex = index;
        }

        slidesWrapper.style.transform = `translateX(-${currentEditorsPicksIndex * 100}%)`;

        dots.forEach((dot, i) => {
            dot.classList.toggle('active', i === currentEditorsPicksIndex);
        });
    }

    function startEditorsPicksRotator() {
        stopEditorsPicksRotator();
        if (editorsPicksArticles.length > 1) {
            editorsPicksIntervalId = setInterval(() => {
                showEditorsPicksSlide(currentEditorsPicksIndex + 1);
            }, EDITORS_PICKS_ROTATION_INTERVAL);
        }
    }

    function stopEditorsPicksRotator() {
        clearInterval(editorsPicksIntervalId);
    }

    function renderNewsletterCard(item) {
        const div = document.createElement('div');
        div.innerHTML = `
            <div class="newsletter-image-wrapper">
                ${item.ImageLink && item.ImageLink.startsWith('http') ? `<img src="${item.ImageLink}" alt="${item.Title || 'Newsletter image'}" class="newsletter-image" onerror="this.onerror=null;this.src='https://placehold.co/250x150/DCDCDC/666666?text=No+Image';"/>` : `<div class="newsletter-image" style="background-color: var(--color-secondary-bg); display: flex; justify-content: center; align-items: center; color: var(--color-text-secondary);">No Image</div>`}
            </div>
            <div class="newsletter-content">
                <a href="${item.Link || '#'}" target="_blank" rel="noopener noreferrer" class="newsletter-title">${item.Title || 'untitled newsletter'}</a>
                <p class="newsletter-subtitle">${item.Description || 'no summary provided.'}</p>
                <p style="font-size: 0.8rem; color: var(--color-text-secondary); opacity: 0.7;">published ${item.Date || 'n.d.'}</p>
            </div>
        `;
        return div;
    }

    document.addEventListener('DOMContentLoaded', () => {
        fetchDataAndDisplay(MAIN_ARCHIVE_SHEET_URL, 'editors-picks-rotator-container', null, 3, { column: 'Medium', value: 'Editor Selection' });
        fetchDataAndDisplay(MAIN_ARCHIVE_SHEET_URL, 'latest-newsletter-container', renderNewsletterCard, 1, { column: 'Medium', value: 'Newsletter' });
    });
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>The Digital Apparatus | Critical Fields</title>
  <link rel="stylesheet" href="styles.css" />
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.0/papaparse.min.js"></script>
  <style>
    body {
      font-family: sans-serif;
      background: #f7f7f7;
      margin: 0;
    }
    header {
      background: black;
      color: white;
      padding: 1rem;
    }
    nav {
      background: #222;
      padding: 0.5rem;
    }
    nav a {
      color: white;
      text-decoration: none;
      margin-right: 1.5rem;
    }
    .dropdown-menu li {
      list-style: none;
    }
    .feed-rotator {
      margin: 2rem auto;
      width: 90%;
      max-width: 800px;
      height: 200px;
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 1rem;
      transition: opacity 0.5s ease-in-out;
    }
  </style>
</head>
<body>

<header>
  <h1>Critical Fields</h1>
  <p style="margin-top: -10px;">The Digital Apparatus</p>
</header>

<nav>
  <a href="index.html">Home</a>
  <a href="fields.html">Fields</a>
  <ul class="dropdown-menu">
    <li><a href="fields-decoloniality.html">Decoloniality / Histories</a></li>
    <li><a href="fields-Power.html">Architectures of Power</a></li>
    <li><a href="fields-Digital.html">The Digital Apparatus</a></li>
    <li><a href="fields-Earth.html">Earth Systems</a></li>
    <li><a href="fields-Social.html">The Social Commons</a></li>
    <li><a href="fields-Critical.html">Critical Methodologies</a></li>
  </ul>
</nav>

<main>
  <section id="live-feed">
    <h2>Live Archive Feed</h2>
    <div id="feed-rotator" class="feed-rotator">Loading articlesâ€¦</div>
  </section>
</main>

<script>
const sheetUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSdn5xz0N63Dzl0n7PRGNTBLk5RkcddzJQ4MoObZJFNeE-9qUbYkdO49bgGlwUyJnby0innAVYaVR7n/pub?output=csv";
const rssProxy = "https://api.rss2json.com/v1/api.json?rss_url=";
const targetField = "The Digital Apparatus";

let allArticles = [];
let currentIndex = 0;

function updateRotator() {
  const container = document.getElementById("feed-rotator");
  if (allArticles.length === 0) {
    container.innerHTML = "<p>No articles found.</p>";
    return;
  }

  const item = allArticles[currentIndex];
  container.innerHTML = `
    <div style="text-align: center">
      <a href="${item.link}" target="_blank"><strong>${item.title}</strong></a><br>
      <em>${item.source}</em>
    </div>`;
  currentIndex = (currentIndex + 1) % allArticles.length;
}

function fetchArticlesFromFeed(feedUrl, sourceName) {
  return fetch(rssProxy + encodeURIComponent(feedUrl))
    .then(res => res.json())
    .then(data => {
      if (!data.items) return [];
      return data.items.slice(0, 3).map(item => ({
        title: item.title,
        link: item.link,
        source: sourceName
      }));
    })
    .catch(() => []);
}

fetch(sheetUrl)
  .then(res => res.text())
  .then(csvText => {
    const parsed = Papa.parse(csvText, { header: true }).data;
    const matchingRows = parsed.filter(row => row.Field === targetField && row["RSS Feed"]);

    const uniqueFeeds = [...new Map(
      matchingRows.map(row => [row["RSS Feed"], row.Source || "Unknown"])
    ).entries()];

    return Promise.all(uniqueFeeds.map(([rss, source]) =>
      fetchArticlesFromFeed(rss, source)
    ));
  })
  .then(results => {
    allArticles = results.flat();
    updateRotator();
    setInterval(updateRotator, 10000);
  })
  .catch(err => {
    document.getElementById("feed-rotator").innerHTML = "<p>Error loading feed.</p>";
    console.error("Feed load error:", err);
  });
</script>

</body>
</html>
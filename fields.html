<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Fields | Critical Fields</title>
    <link rel="stylesheet" href="styles.css" />
    <link
      href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono&display=swap"
      rel="stylesheet"
    />
    <style>
      /* Minimal inline styles to complement styles.css for the Fields page */
      body {
        font-family: 'IBM Plex Mono', monospace;
        background-color: var(--color-main-bg);
        color: var(--color-text-primary);
        margin: 0;
        padding: 0;
        line-height: 1.7;
        letter-spacing: -0.01em;
        overflow-x: hidden;
        position: relative;
      }
      main {
        padding: 2rem;
        max-width: 1200px;
        margin: 0 auto;
      }

      /* Hero Section (Compressed Further) */
      .field-hero {
        text-align: center;
        padding: 0.5rem 0.5rem;
        background: var(--color-secondary-bg);
        color: var(--color-text-primary);
        border-bottom: 1px solid var(--color-border-dark);
        box-shadow: var(--shadow-element);
        border-radius: 4px;
        border: 1px solid var(--color-border-dark);
        margin-bottom: 1rem;
      }
      .field-hero h2 {
        font-size: 2rem;
        margin-bottom: 0.5rem;
        text-transform: lowercase;
        color: var(--color-accent-highlight);
        text-shadow: 0 0 8px rgba(255, 65, 54, 0.5);
      }
      .field-hero p {
        font-size: 1rem;
        max-width: 1100px;
        margin: 0 auto;
        line-height: 1.5;
        color: var(--color-text-secondary);
      }
      .field-section-title {
        text-align: center;
        font-size: 2rem;
        margin-top: 1rem;
        margin-bottom: 1rem; /* Adjusted for better spacing below the title */
        color: var(--color-accent-highlight);
        border-bottom: 1px solid var(--color-border-dark);
        padding-bottom: 0.5rem;
        display: block;
        max-width: fit-content;
        letter-spacing: 1px;
        margin-left: auto;
        margin-right: auto;
      }
      .content-area {
        margin-bottom: 3rem;
      }
      .content-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 1.5rem;
      }
      .feature-card {
        background: var(--color-card-bg);
        border: 1px solid var(--color-border-dark);
        border-radius: 4px;
        box-shadow: var(--shadow-outset-top), var(--shadow-outset-bottom),
          4px 4px 0px var(--color-border-dark);
        overflow: hidden;
        text-decoration: none;
        color: inherit;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
        display: flex;
        flex-direction: column;
        height: 100%;
      }
      .feature-card:hover {
        transform: translateY(-3px);
        box-shadow: var(--shadow-outset-top), var(--shadow-outset-bottom),
          6px 6px 0px rgba(0, 0, 0, 0.4);
      }
      .feature-card-content {
        padding: 1rem;
        flex-grow: 1;
        display: flex;
        flex-direction: column;
      }
      .feature-card-content h4 {
        margin: 0 0 0.5rem;
        font-size: 1.05rem;
        color: var(--color-accent-highlight);
        line-height: 1.4;
      }
      .feature-card-content p {
        font-size: 0.85rem;
        color: var(--color-text-secondary);
        line-height: 1.5;
        margin-bottom: 0.75rem;
        flex-grow: 1;
      }
      .feature-card-meta {
        font-size: 0.75rem;
        color: var(--color-text-secondary);
        margin-top: auto;
        text-align: right;
        opacity: 0.8;
      }
      .loading-message {
        text-align: center;
        padding: 1.5rem;
        font-size: 1rem;
        color: var(--color-text-secondary);
        grid-column: 1 / -1;
        font-style: italic;
        border: 1px dashed var(--color-border-dark);
        border-radius: 4px;
        background-color: var(--color-secondary-bg);
      }
      .error-message {
        color: var(--color-ui-red);
      }

      .coming-soon {
        text-align: center;
        padding: 2rem;
        font-style: italic;
        color: var(--color-text-secondary);
        font-size: 1.1rem;
        grid-column: 1 / -1;
        border: 1px dashed var(--color-border-dark);
        border-radius: 4px;
        background-color: var(--color-secondary-bg);
      }

      /* --- RSS List Styles (Native Scroll, No Images) --- */
      #rss-vertical-list-section {
        background-color: var(--color-card-bg);
        padding-top: 0.5rem;
        padding-right: 2rem;
        padding-bottom: 2rem;
        padding-left: 2rem;
        border-radius: 8px;
        border: 1px solid var(--color-border-dark);
        box-shadow: var(--shadow-outset-top), var(--shadow-outset-bottom),
          4px 4px 0px var(--color-border-dark);
        text-align: center;
        margin-bottom: 3rem;
        /* Image overlay for RSS section */
        position: relative;
      }

      #rss-vertical-list-section::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: rgba(0, 0, 0, 0.4); /* Dark overlay */
        z-index: 1;
        border-radius: 8px;
      }

      #rss-vertical-list-section > *:not(.field-section-title) {
        /* Apply z-index to content inside RSS section to be above overlay */
        position: relative;
        z-index: 2;
      }
      #rss-vertical-list-section .field-section-title {
        position: relative;
        z-index: 2;
      }

      .vertical-articles-list-wrapper {
        max-width: 800px;
        width: 100%;
        height: 270px;
        overflow-y: scroll;
        -webkit-overflow-scrolling: touch;
        scrollbar-width: thin;
        scrollbar-color: var(--color-accent-highlight)
          var(--color-secondary-bg);

        border: 1px solid var(--color-border-dark);
        border-radius: 4px;
        background-color: var(--color-secondary-bg);
        box-shadow: inset 1px 1px 0px var(--color-border-dark),
          inset -1px -1px 0px var(--color-border-light);
        padding: 10px;
        box-sizing: border-box;
        margin: 0 auto;
      }
      /* Styles for the scrollbar itself (Webkit browsers like Chrome/Safari) */
      .vertical-articles-list-wrapper::-webkit-scrollbar {
        width: 8px;
      }
      .vertical-articles-list-wrapper::-webkit-scrollbar-track {
        background: var(--color-secondary-bg);
        border-radius: 10px;
      }
      .vertical-articles-list-wrapper::-webkit-scrollbar-thumb {
        background: var(--color-accent-highlight);
        border-radius: 10px;
        border: 2px solid var(--color-secondary-bg);
      }
      .vertical-articles-list-wrapper::-webkit-scrollbar-thumb:hover {
        background: var(--color-ui-red-light);
      }

      .vertical-articles-list {
        list-style: decimal;
        padding-left: 25px;
        margin: 0;
        display: flex;
        flex-direction: column;
        width: 100%;
        height: auto;
      }

      .vertical-article-item {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 8px 0;
        border-bottom: 1px dashed var(--color-border-dark);
        text-align: left;
        min-height: 80px;
      }

      .vertical-article-item:last-child {
        border-bottom: none;
      }

      .article-text-content {
        flex-grow: 1;
      }

      .article-title-small {
        font-size: 0.95rem;
        margin: 0 0 2px;
        line-height: 1.3;
      }
      .article-title-small a {
        color: var(--color-text-primary);
        text-decoration: none;
        font-weight: 600;
      }
      .article-title-small a:hover {
        color: var(--color-accent-highlight);
        text-decoration: underline;
      }

      .article-meta-small {
        font-size: 0.75rem;
        color: var(--color-text-secondary);
        opacity: 0.8;
        margin: 0;
      }

      /* --- Simple List Styling for Foundational Resources --- */
      #foundational-resources-section {
        background-color: var(--color-card-bg);
        padding: 1rem 2rem 2rem;
        border-radius: 8px;
        border: 1px solid var(--color-border-dark);
        box-shadow: var(--shadow-outset-top), var(--shadow-outset-bottom),
          4px 4px 0px var(--color-border-dark);
        text-align: center;
        height: 100%;
        display: flex;
        flex-direction: column;
      }

      .basic-numbered-list {
        list-style: decimal;
        padding-left: 25px;
        margin: 0 auto;
        max-width: 800px;
        background-color: var(--color-secondary-bg);
        border: 1px solid var(--color-border-dark);
        border-radius: 4px;
        box-shadow: inset 1px 1px 0px var(--color-border-dark),
          inset -1px -1px 0px var(--color-border-light);
        padding: 1.5rem 25px 1.5rem;
        text-align: left;
        overflow-y: scroll;
        -webkit-overflow-scrolling: touch;
        scrollbar-width: thin;
        scrollbar-color: var(--color-accent-highlight)
          var(--color-secondary-bg);
        height: 300px;
      }

      /* Scrollbar styles for basic-numbered-list */
      .basic-numbered-list::-webkit-scrollbar {
        width: 8px;
      }
      .basic-numbered-list::-webkit-scrollbar-track {
        background: var(--color-secondary-bg);
        border-radius: 10px;
      }
      .basic-numbered-list::-webkit-scrollbar-thumb {
        background: var(--color-accent-highlight);
        border-radius: 10px;
        border: 2px solid var(--color-secondary-bg);
      }
      .basic-numbered-list::-webkit-scrollbar-thumb:hover {
        background: var(--color-ui-red-light);
      }

      .basic-numbered-list li {
        margin-bottom: 0.8rem;
        font-size: 1rem;
        color: var(--color-text-primary);
        border-bottom: 1px dashed var(--color-border-dark);
        padding-bottom: 0.8rem;
        line-height: 1.6;
      }
      .basic-numbered-list li:last-child {
        border-bottom: none;
        margin-bottom: 0;
        padding-bottom: 0;
      }
      .basic-numbered-list li a {
        color: var(--color-text-primary);
        text-decoration: none;
        font-weight: 600;
      }
      .basic-numbered-list li a:hover {
        color: var(--color-accent-highlight);
        text-decoration: underline;
      }
      .basic-numbered-list li .item-meta {
        font-size: 0.85rem;
        color: var(--color-text-secondary);
        opacity: 0.8;
        display: block;
        margin-top: 0.2rem;
      }

      /* --- Field Index Page Styles (Digital Card Catalog Style) --- */
      #field-index-wrapper {
        background-color: var(--color-card-bg);
        border: 1px solid var(--color-border-dark);
        border-radius: 4px;
        box-shadow: var(--shadow-outset-top), var(--shadow-outset-bottom),
          4px 4px 0px var(--color-border-dark);
        padding: 2rem;
        max-width: 1000px;
        margin: 3rem auto;
        text-align: center;
      }

      #field-catalog-container {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 1.5rem;
        padding: 1rem 0;
        justify-content: center;
        text-align: left;
      }

      .field-catalog-item {
        background-color: var(--color-secondary-bg);
        border: 1px solid var(--color-border-dark);
        border-radius: 4px;
        box-shadow: var(--shadow-outset-top), var(--shadow-outset-bottom),
          2px 2px 0px var(--color-border-dark);
        padding: 1.5rem;
        text-decoration: none;
        color: inherit;
        transition: all 0.2s ease;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        align-items: flex-start;
        text-align: left;
      }

      .field-catalog-item:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-outset-top), var(--shadow-outset-bottom),
          4px 4px 0px rgba(0, 0, 0, 0.4);
        background-color: var(--color-card-bg);
        border-color: var(--color-ui-red);
      }

      .field-catalog-item .catalog-title {
        font-size: 1.25rem;
        font-weight: bold;
        color: var(--color-accent-highlight);
        text-transform: uppercase;
        margin-bottom: 0.8rem;
        line-height: 1.2;
      }

      .field-catalog-item .catalog-description {
        font-size: 0.9rem;
        color: var(--color-text-secondary);
        line-height: 1.6;
        margin-bottom: 1rem;
        flex-grow: 1;
      }

      .field-catalog-item .cta-link {
        display: inline-block;
        font-size: 0.9rem;
        font-weight: 600;
        color: var(--color-ui-red);
        text-decoration: underline;
        text-transform: lowercase;
        margin-top: auto;
      }
      .field-catalog-item .cta-link:hover {
        color: var(--color-ui-red-light);
      }

      /* --- REVISED STYLES FOR FOUNDATIONAL THINKERS LIST (DROPDOWN) --- */
      .content-columns-below-rss {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 2rem;
        margin-top: 2rem;
        margin-bottom: 3rem;
      }

      #foundational-thinkers-section {
        background-color: var(--color-card-bg);
        padding: 1rem 2rem 2rem;
        border-radius: 8px;
        border: 1px solid var(--color-border-dark);
        box-shadow: var(--shadow-outset-top),
          var(--shadow-outset-bottom), 4px 4px 0px var(--color-border-dark);
        text-align: center;
        display: flex;
        flex-direction: column;
        height: 100%;
      }

      #foundational-thinkers-container {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
        padding: 1rem 0;
        overflow-y: scroll; /* Ensure scrollability */
        -webkit-overflow-scrolling: touch;
        scrollbar-width: thin;
        scrollbar-color: var(--color-accent-highlight)
          var(--color-secondary-bg);
        /* Calculate height for approximately 4 items:
         * Each item: padding-top (0.8rem) + padding-bottom (0.5rem) + border (1px) + font-size (0.95rem) + margin-bottom of next item (0.5rem)
         * Roughly 4 * (0.8 + 0.5 + 0.95 + 0.5)rem + 3 * 0.5rem (for gaps) + 20px (container padding)
         * Let's simplify to a fixed height for visual consistency, or dynamically calculate based on average item height.
         * For now, let's target about 250px-300px which fits 3-4 items well.
         */
        height: 300px;

        border: 1px solid var(--color-border-dark);
        border-radius: 4px;
        background-color: var(--color-secondary-bg);
        box-shadow: inset 1px 1px 0px var(--color-border-dark),
          inset -1px -1px 0px var(--color-border-light);
        padding: 10px; /* Internal padding for the scrollable area */
        box-sizing: border-box;
        text-align: left;
      }

      /* Scrollbar styles for foundational-thinkers-container (remain the same) */
      #foundational-thinkers-container::-webkit-scrollbar {
        width: 8px;
      }
      #foundational-thinkers-container::-webkit-scrollbar-track {
        background: var(--color-secondary-bg);
        border-radius: 10px;
      }
      #foundational-thinkers-container::-webkit-scrollbar-thumb {
        background: var(--color-accent-highlight);
        border-radius: 10px;
        border: 2px solid var(--color-secondary-bg);
      }
      .foundational-thinkers-container::-webkit-scrollbar-thumb:hover {
        background: var(--color-ui-red-light);
      }

      .thinker-list-item {
        background: var(--color-card-bg);
        border: 1px solid var(--color-border-dark);
        border-radius: 4px;
        box-shadow: 2px 2px 0px var(--color-border-dark);
        padding: 0.8rem;
        cursor: pointer;
        transition: all 0.2s ease;
        overflow: hidden; /* Ensures description content is clipped when collapsed */
        display: flex;
        flex-direction: column;
        align-items: flex-start;
      }

      .thinker-list-item:hover {
        transform: translateY(-2px);
        box-shadow: 4px 4px 0px rgba(0, 0, 0, 0.4);
        border-color: var(--color-accent-highlight);
      }

      .thinker-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        width: 100%;
        padding-bottom: 0.5rem;
        border-bottom: 1px dashed transparent; /* Initially transparent */
        transition: border-bottom 0.3s ease;
      }

      .thinker-list-item.expanded .thinker-header {
        border-bottom: 1px dashed var(--color-border-dark); /* Solid border when expanded */
      }

      .thinker-name {
        font-size: 0.95rem; /* Slightly reduced font size to prevent cutting off */
        font-weight: bold;
        color: var(--color-text-primary); /* Changed for better contrast and readability */
        margin: 0;
        line-height: 1;
        text-transform: lowercase;
        flex-grow: 1;
        min-width: 1px; /* Prevents text from being squished, allows proper wrapping if needed */
      }

      .dropdown-arrow {
        font-size: 0.8em;
        color: var(--color-text-secondary);
        transition: transform 0.3s ease;
        margin-left: 10px;
        flex-shrink: 0; /* Prevent arrow from shrinking */
      }

      .thinker-list-item.expanded .dropdown-arrow {
        transform: rotate(90deg); /* Rotate arrow when expanded */
      }

      .thinker-description {
        font-size: 0.85rem;
        color: var(--color-text-secondary);
        line-height: 1.5;
        max-height: 0; /* Initially hidden */
        opacity: 0;
        overflow: hidden; /* Crucial for smooth slide-down */
        transition: max-height 0.4s ease-out, opacity 0.4s ease-out,
          padding-top 0.4s ease-out;
        padding-top: 0; /* No padding when collapsed */
        text-align: left;
        width: 100%;
      }

      .thinker-list-item.expanded .thinker-description {
        max-height: 1000px; /* Greatly increased to ensure full description visibility for any length */
        opacity: 1;
        padding-top: 0.8rem; /* Padding when expanded */
      }


          /* Styles for dropdown menu */
    .navbar .dropdown {
        position: relative;
    }

    .navbar .dropdown-menu {
        display: none;
        position: absolute;
        background-color: var(--color-secondary-bg);
        box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
        z-index: 1000; /* Increased z-index to ensure it appears above other content */
        min-width: 160px;
        list-style: none;
        padding: 0;
        margin: 0;
        border: 1px solid var(--color-border-dark);
        border-radius: 4px;
        left: 0; /* Align dropdown with the parent link */
        top: 100%; /* Position below the parent link */
    }

    .navbar .dropdown-menu li a {
        color: var(--color-text-primary);
        padding: 12px 16px;
        text-decoration: none;
        display: block;
        text-align: left;
        white-space: nowrap; /* Prevent wrapping */
    }

    .navbar .dropdown-menu li a:hover {
        background-color: var(--color-main-bg);
        color: var(--color-accent-highlight);
    }

    .navbar .dropdown:hover .dropdown-menu {
        display: block;
    }

    /* Responsive adjustments for dropdown on mobile, if needed */
    @media (max-width: 768px) {
        .dropdown-menu {
            position: static; /* Change to static on mobile so it flows with content */
            width: 100%; /* Take full width */
            margin-top: 0.5rem; /* Space below main nav item */
            box-shadow: none; /* Remove extra shadows on mobile dropdown */
            border: none; /* Remove border from dropdown */
            background-color: transparent; /* Transparent background */
        }
        .dropdown-menu li a {
            padding: 0.4rem 1rem; /* Adjusted padding */
            text-align: center; /* Center dropdown items */
        }
    }
      /* Responsive adjustments */
      @media (max-width: 900px) {
        /* The overall main padding is adjusted */
        main {
          padding: 1.5rem;
        }

        /* Adjust new column layout to stack on smaller screens */
        .content-columns-below-rss {
          grid-template-columns: 1fr;
          gap: 3rem;
        }

        .field-hero {
          margin-bottom: 0;
        }
        /* Mobile-specific margin-bottom for RSS section */
        #rss-vertical-list-section {
          margin-bottom: 2rem;
        }

        .vertical-articles-list-wrapper {
          height: 280px;
          padding: 8px;
        }
        .vertical-article-item {
          min-height: auto;
          padding: 8px 0;
        }
        .article-title-small {
          font-size: 0.9em;
        }
        .article-meta-small {
          font-size: 0.7em;
        }

        #foundational-thinkers-container,
        .basic-numbered-list {
          height: 250px;
        }
        #foundational-thinkers-section,
        #foundational-resources-section {
          padding: 1rem;
        }

        /* For thinker list on mobile */
        .thinker-name {
          font-size: 0.9rem;
        }
        .thinker-description {
          font-size: 0.8rem;
        }

        /* Field Index Page Responsive */
        #field-index-wrapper {
          padding: 1.5rem;
        }
        #field-catalog-container {
          grid-template-columns: 1fr;
          padding: 1rem;
        }
        .field-catalog-item {
          padding: 1rem;
        }
        .field-catalog-item .catalog-title {
          font-size: 1.1rem;
        }
        .field-catalog-item .catalog-description {
          font-size: 0.85rem;
        }
      }
    </style>
  </head>
  <body>
    <header class="site-header">
      <nav class="navbar">
        <h1 class="logo">Critical Fields</h1>
        <ul class="nav-menu">
          <li><a href="index.html">Home</a></li>
          <li><a href="fields.html">Fields</a></li> <li class="dropdown">
            <a href="#">Archive</a> <ul class="dropdown-menu">
              <li><a href="resources.html">Resources</a></li>
              <li><a href="files.html">Files</a></li>
            </ul>
          </li>
          <li><a href="network.html">Network</a></li>
          <li><a href="about.html">About</a></li>
        </ul>
      </nav>
    </header>

    <main id="main-content-area"></main>

    <footer class="site-footer">
      <p>&copy; 2025 Critical Fields.</p>
    </footer>

    <script>
      // --- Configuration for Field Page Dynamic Content ---
      // Your comprehensive Archive Sheet URL (used for all content pulling from your sheet)
      const GOOGLE_SHEET_COMPREHENSIVE_ARCHIVE_URL =
        'https://docs.google.com/spreadsheets/d/e/2PACX-1vQjynyBounT-LDTVS7xiQvSLbJG1zzyEYzveGmS8TrPf06kePylqpWg-Ry7pdd0LOKD5pgRWg-JYqAN/pub?output=csv';

      // *** NEW: Your Backend API URL *** // When deployed, this will change to your actual deployed backend URL
      const BACKEND_RSS_API_URL =
        window.location.hostname === 'localhost' ||
        window.location.hostname === '127.0.0.1'
          ? 'http://localhost:3000/api/field-rss' // Local backend address
          : 'https://critical-fields-site.onrender.com/api/field-rss'; // Deployed Render backend address

      // Map of field names (from URL param) to their display titles and descriptions
      const fieldData = {
        'heterodox-economics': {
          title: 'Heterodox Economics',
          shortBlurb:
            'Challenging mainstream economics with diverse perspectives on markets, society, and power.',
          longBlurb:
            'This field questions the stories we are told about the economy. We move beyond mainstream analysis to ask how value is created, who is exploited, and how corporate and financial power distort our world. We are here not just to map the contradictions of the present system, but to explore what might lie beyond it.',
          archiveBgImage:
            'https://i.pinimg.com/1200x/11/90/79/1190796d096d4a9db89cb89f77f022e2.jpg',
        },
        'architectures-of-power': {
          title: 'Architectures of Power',
          shortBlurb:
            'Investigating the structures that shape governance, control, and political power.',
          longBlurb:
            'This field examines how power operates in the modern world. We trace its systems of control through our laws, militaries, borders, and histories. This is a space for understanding power not as an abstract concept, but as a designed reality that can be investigated, understood, and ultimately challenged.',
          archiveBgImage:
            'https://i.pinimg.com/1200x/a3/ae/91/a3ae91ca2d9255801c7183c0ba9eb690.jpg',
        },
        'the-digital-apparatus': {
          title: 'The Digital Apparatus',
          shortBlurb:
            'A guide to the tech that runs our world—and a blueprint for a better one.',
          longBlurb:
            'Dismantling the fantasy of techno-optimism to reveal the machine at work: a system of algorithmic governance and mass surveillance designed for profit and control. This is also a workshop for the future. Here, we collect and explore the tools, strategies, and radical visions needed to build a new world from the fragments of the old.',
          archiveBgImage:
            'https://i.pinimg.com/1200x/92/5e/e7/925ee77a7c0d6e0af41ba5b3d37cb73f.jpg',
        },
        'earth-systems': {
          title: 'Earth Systems',
          shortBlurb:
            'Exploring the relationships between human societies and planetary ecologies, climate, and environmental justice.',
          longBlurb:
            'The planet isn\'t dying, it\'s being killed. This field is our investigation into the crime. Here, we explore the systemic changes required to build a more sustainable relationship with our planet.',
          archiveBgImage:
            'https://i.pinimg.com/1200x/22/cd/d4/22cdd4cb1f3e6b86ae4250cbba34e6fd.jpg',
        },
        'the-social-commons': {
          title: 'The Social Commons',
          shortBlurb:
            'Exploring the shared space between us: our culture, communities, and public life.',
          longBlurb:
            'It all starts in the space between people. That’s where culture happens, where power is contested, and where life gets its meaning. Here, we examine everything that fills it—art, media, memory, and identity—to ask a simple question: how could we live together differently?',
          archiveBgImage:
            'https://i.pinimg.com/1200x/cf/b2/d7/cfb2d76d40a08b2b3b0109af97152ef9.jpg',
        },
        'critical-methodologies': {
          title: 'Critical Methodologies',
          shortBlurb:
            'Examining the tools and approaches for rigorous inquiry in critical studies.',
          longBlurb:
            'This field focuses on the theoretical and practical frameworks that underpin critical research. We explore interdisciplinary methods, ethical considerations, and innovative approaches to knowledge production, ensuring the rigor and relevance of our inquiries.',
          archiveBgImage:
            'https://i.pinimg.com/1200x/16/d2/5b/16d25b8aadb360f5b99c40ce9d43092c.jpg',
        },
      };

      // Helper function to parse CSV data (REVISED FOR MULTI-LINE QUOTED FIELDS)
      function parseCSV(csvText) {
          const rows = [];
          let currentRow = [];
          let currentField = '';
          let inQuote = false;
          let escapedQuote = false; // To handle "" inside a quoted field

          for (let i = 0; i < csvText.length; i++) {
              const char = csvText[i];
              const nextChar = csvText[i + 1];

              if (char === '"') {
                  if (inQuote) {
                      if (nextChar === '"') { // It's an escaped double quote ("" inside "")
                          currentField += char; // Add the first "
                          i++; // Skip the second "
                          escapedQuote = true; // Mark that we just handled an escaped quote
                      } else { // It's the closing quote
                          inQuote = false;
                      }
                  } else { // It's an opening quote
                      inQuote = true;
                      escapedQuote = false; // Reset escaped quote flag
                  }
              } else if (char === ',') {
                  if (inQuote) {
                      currentField += char;
                  } else {
                      currentRow.push(currentField.trim());
                      currentField = '';
                  }
              } else if (char === '\n') {
                  if (inQuote) {
                      currentField += char; // Keep newlines if inside a quoted field
                  } else {
                      // Handle Windows newlines (\r\n) by stripping \r if present before \n
                      if (csvText[i - 1] === '\r') {
                          currentRow.push(currentField.trim());
                          currentField = '';
                          rows.push(currentRow);
                          currentRow = [];
                      } else {
                          currentRow.push(currentField.trim());
                          currentField = '';
                          rows.push(currentRow);
                          currentRow = [];
                      }
                  }
              } else if (char === '\r' && !inQuote) { // Ignore standalone \r unless inside a quote
                  // This handles windows style newlines (\r\n) where \r precedes \n
                  // If we are not in a quote, and we see a \r, it's part of a line ending.
                  // We'll handle the actual row break on the '\n'.
              }
              else {
                  currentField += char;
              }
          }

          // Push the very last field and row if any
          if (currentField !== '' || currentRow.length > 0) {
              currentRow.push(currentField.trim());
              rows.push(currentRow);
          }


          // After parsing all rows, map to objects based on headers
          if (rows.length === 0) return [];

          const headers = rows[0].map(header => {
              return header.trim().replace(/[^a-zA-Z0-9]/g, ''); // Ensure consistent normalization
          });

          const data = [];
          for (let i = 1; i < rows.length; i++) {
              const rowValues = rows[i];
              // Skip rows that are empty or clearly malformed after robust parsing attempt
              if (rowValues.every(val => val === '') || rowValues.length === 0) {
                  continue;
              }

              // If a row still doesn't match header length, it's truly malformed or incomplete.
              // This is where your previous warnings came from. With this new parser,
              // ideally, this check should pass for almost all rows now.
              if (rowValues.length !== headers.length) {
                  console.warn(`Skipping potentially malformed row due to column count mismatch after robust parse:`, rowValues);
                  continue;
              }

              const rowObject = {};
              headers.forEach((header, index) => {
                  rowObject[header] = rowValues[index] ? rowValues[index] : '';
                  rowObject[`${header}Normalized`] = rowValues[index] ? rowValues[index].toLowerCase().trim() : '';
              });

              // Ensure 'Field' column is parsed as a lowercase, hyphenated array for filtering
              if (rowObject.Field) {
                  rowObject.FieldParsed = rowObject.Field.toLowerCase().split(',').map(f => f.trim().replace(/\s/g, '-')).filter(Boolean);
              } else {
                  rowObject.FieldParsed = [];
              }
              data.push(rowObject);
          }
          return data;
      }

      // Generic function to fetch and display data from the comprehensive sheet with filters
      async function fetchDataAndDisplay(
        url,
        targetContainerId,
        renderFunction,
        currentFieldName = null,
        filterOptions = {},
      ) {
        const container = document.getElementById(targetContainerId);
        let loadingElement = container.querySelector('.loading-message');
        let comingSoonElement = container.querySelector('.coming-soon');

        if (comingSoonElement) comingSoonElement.style.display = 'none';
        if (!loadingElement) {
          loadingElement = document.createElement('p');
          loadingElement.className = 'loading-message';
          loadingElement.textContent = 'Loading content...';
          container.appendChild(loadingElement);
        }
        loadingElement.style.display = 'block';
        container.innerHTML = '';
        container.appendChild(loadingElement);

        try {
          const response = await fetch(url);
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          const csvText = await response.text();
          let data = parseCSV(csvText);

          // Filter by field name from URL
          if (currentFieldName) {
            const normalizedFieldName = currentFieldName
              .toLowerCase()
              .replace(/\s/g, '-');
            data = data.filter(
              (item) =>
                item.FieldParsed &&
                item.FieldParsed.includes(normalizedFieldName),
            );
          }

          // Apply additional filter options (e.g., by Medium, FoundationalStatus, ThinkerStatus)
          if (filterOptions.medium) {
            data = data.filter(
              (item) =>
                item.MediumNormalized &&
                item.MediumNormalized.includes(filterOptions.medium.toLowerCase()),
            );
          }
          if (filterOptions.foundationalStatus) {
            data = data.filter(
              (item) =>
                item.FoundationalStatusNormalized &&
                item.FoundationalStatusNormalized ===
                  filterOptions.foundationalStatus.toLowerCase(),
            );
          }
          if (filterOptions.thinkerStatus) {
            data = data.filter(
              (item) =>
                item.ThinkerStatusNormalized &&
                item.ThinkerStatusNormalized ===
                  filterOptions.thinkerStatus.toLowerCase(),
            );
          }

          // *** ADDED FOR DEBUGGING: Log the filtered data ***
          console.log(`Data for ${targetContainerId}:`, data);
          // *************************************************

          if (data.length === 0) {
            container.innerHTML = '';
            if (comingSoonElement) {
              container.appendChild(comingSoonElement);
              comingSoonElement.style.display = 'block';
            } else {
              container.innerHTML = `<p class="loading-message">No content available yet.</p>`;
            }
            return;
          }

          container.innerHTML = '';

          data.forEach((item) => {
            const element = renderFunction(item);
            if (element) {
              container.appendChild(element);
            }
          });
        } catch (error) {
          console.error(
            `Error fetching or rendering data for ${targetContainerId} from ${url}:`,
            error,
          );
          container.innerHTML = `<p class="loading-message error-message">Failed to load content for this section.</p>`;
        } finally {
          if (loadingElement) {
            loadingElement.style.display = 'none';
          }
        }
      }

      let verticalRssArticles = [];

      // Function to render RSS articles in a scrollable vertical list
      function renderVerticalRssList(articles) {
        const listContainer = document.getElementById(
          'vertical-rotator-content-wrapper',
        );
        listContainer.innerHTML = '';

        articles.sort((a, b) => {
          const dateA = Date.parse(a.pubDate);
          const dateB = Date.parse(b.pubDate);
          if (isNaN(dateA) && isNaN(dateB)) return 0;
          if (isNaN(dateA)) return 1;
          if (isNaN(dateB)) return -1;
          return dateB - dateA;
        });

        verticalRssArticles = articles.slice(0, 10);

        if (verticalRssArticles.length === 0) {
          listContainer.innerHTML =
            '<p class="loading-message">no recent articles available for this field yet.</p>';
          return;
        }

        const articlesList = document.createElement('ol');
        articlesList.className = 'vertical-articles-list';
        listContainer.appendChild(articlesList);

        verticalRssArticles.forEach((article) => {
          const articleItem = document.createElement('li');
          articleItem.classList.add('vertical-article-item');

          articleItem.innerHTML = `
                    <div class="article-text-content">
                            <h3 class="article-title-small"><a href="${article.link}" target="_blank" rel="noopener noreferrer">${article.title}</a></h3>
                            <p class="article-meta-small">Source: ${article.feedTitle || 'N/A'} | ${new Date(article.pubDate).toLocaleDateString()}</p>
                    </div>
                    `;
          articlesList.appendChild(articleItem);
        });
      }

      // FETCHES RSS ARTICLES FROM YOUR BACKEND API
      async function fetchFieldRssFeeds(currentFieldName) {
        const listSection = document.getElementById(
          'rss-vertical-list-section',
        );
        const listContentWrapper = document.getElementById(
          'vertical-rotator-content-wrapper',
        );

        const loadingMessage =
          listContentWrapper.querySelector('.loading-message') ||
          document.createElement('p');
        if (!loadingMessage.parentNode) {
          loadingMessage.className = 'loading-message';
          listContentWrapper.appendChild(loadingMessage);
        }
        loadingMessage.innerHTML =
          '<div class="loader"></div>' +
          (loadingMessage.dataset.originalText ||
            loadingMessage.textContent ||
            'loading live RSS articles...');
        loadingMessage.dataset.originalText =
          loadingMessage.dataset.originalText || loadingMessage.textContent;
        loadingMessage.style.display = 'block';

        try {
          const response = await fetch(
            `${BACKEND_RSS_API_URL}?field=${currentFieldName}`,
          );
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          const articles = await response.json();

          console.log('Articles received for', currentFieldName, ':', articles);

          if (articles.length === 0) {
            listContentWrapper.innerHTML = `<p class="loading-message">no recent articles available for this field yet.</p>`;
            return;
          }

          renderVerticalRssList(articles);
        } catch (error) {
          console.error('Error fetching RSS articles from backend:', error);
          listContentWrapper.innerHTML = `<p class="loading-message error-message">Failed to load live RSS feed. </p>`;
        } finally {
          if (loadingMessage) {
            loadingMessage.style.display = 'none';
          }
        }
      }

      // Render Functions for Field Page Sections
      function renderFieldNotesCard(item) {
        const card = document.createElement('div');
        card.className = 'coming-soon';
        card.innerHTML = `<p>Field Notes (User Comments) coming soon!</p>`;
        return card;
      }

      // Foundational Resources now uses static "Coming Soon" message in HTML
      // This function is no longer called for that section.
      function renderFoundationalResourceItem(item) {
        const listItem = document.createElement('li');
        listItem.innerHTML = `
            <a href="${item.Link || '#'}" target="_blank" rel="noopener noreferrer">${item.Name || 'untitled resource'}</a>
            <span class="item-meta">Description: ${item.Description || 'N/A'}</span>
        `;
        return listItem;
      }

      // Re-introducing the render function for the dropdown list items
      function renderFoundationalThinkerCard(item) {
        // Create the main container div for each thinker
        const listItem = document.createElement('div');
        listItem.className = 'thinker-list-item';

        // Create the header section (clickable part)
        const thinkerHeader = document.createElement('div');
        thinkerHeader.className = 'thinker-header';

        // Create the thinker's name (using item.Name as per your CSV columns)
        const thinkerName = document.createElement('h4');
        thinkerName.className = 'thinker-name';
        thinkerName.textContent = item.Name || 'Unknown Thinker'; // Direct use of item.Name

        // Create the dropdown arrow
        const dropdownArrow = document.createElement('span');
        dropdownArrow.className = 'dropdown-arrow';
        dropdownArrow.innerHTML = '&#9660;'; // Downward-pointing triangle

        // Append name and arrow to the header
        thinkerHeader.appendChild(thinkerName);
        thinkerHeader.appendChild(dropdownArrow);

        // Create the description paragraph (using item.Description as per your CSV columns)
        const thinkerDescription = document.createElement('p');
        thinkerDescription.className = 'thinker-description';
        thinkerDescription.textContent =
          item.Description || 'No description available.'; // Direct use of item.Description

        // Append header and description to the main list item div
        listItem.appendChild(thinkerHeader);
        listItem.appendChild(thinkerDescription);

        // Add click event listener to toggle description visibility
        thinkerHeader.addEventListener('click', () => {
          listItem.classList.toggle('expanded');
        });

        return listItem;
      }

      function renderWeeklyBriefingCard(item) {
        const card = document.createElement('a');
        card.href = item.Link || '#';
        card.target = '_blank';
        card.rel = 'noopener noreferrer';
        card.className = 'feature-card';
        card.innerHTML = `
            <div class="feature-card-content">
                <h4>${item.Title || 'untitled briefing'}</h4>
                <p>${item.Description || 'no summary provided.'}</p>
                <div class="feature-card-meta">
                    ${item.Date || 'n.d.'}
                </div>
            </div>
            `;
        return card;
      }

      function renderPeopleInstitutionsCard(item) {
        /* ... */ return null;
      }
      function renderFormalPublicationCard(item) {
        /* ... */ return null;
      }
      function renderReadingListCard(item) {
        /* ... */ return null;
      }
      function renderUpcomingEventCard(item) {
        /* ... */ return null;
      }

      // --- Main Field Page Initialization (handles both index and individual fields) ---
      document.addEventListener('DOMContentLoaded', () => {
        const mainContentArea = document.getElementById('main-content-area');
        const urlParams = new URLSearchParams(window.location.search);
        const fieldNameParam = urlParams.get('name');

        if (fieldNameParam) {
          // --- Render Individual Field Page ---
          const fieldDetails = fieldData[fieldNameParam];

          if (fieldDetails) {
            document.title = `${fieldDetails.title} | Critical Fields`;

            // Updated HTML structure for individual field page
            mainContentArea.innerHTML = `
                        <section class="field-hero">
                                <h2 id="field-title">${fieldDetails.title}</h2>
                                <p id="field-description">${fieldDetails.longBlurb}</p>
                        </section>

                        <section id="rss-vertical-list-section" class="content-area">
                                <h3 class="field-section-title">Archive Blog</h3>
                                <div class="vertical-articles-list-wrapper" id="vertical-rotator-content-wrapper">
                                        <p class="loading-message">Loading recent articles...</p>
                                </div>
                        </section>

                        <div class="content-columns-below-rss">
                                <section id="foundational-thinkers-section" class="content-area">
                                        <h3 class="field-section-title">Foundational Thinkers</h3>
                                        <div id="foundational-thinkers-container">
                                                <p class="loading-message">Loading foundational thinkers...</p>
                                        </div>
                                </section>

                                <section id="foundational-resources-section" class="content-area">
                                        <h3 class="field-section-title">Foundational Resources</h3>
                                        <div id="foundational-resources-container" class="basic-numbered-list">
                                                <p class="coming-soon">Foundational Resources coming soon!</p>
                                        </div>
                                </section>
                        </div>
                        <section class="content-area">
                                <h3 class="field-section-title">Field Notes</h3>
                                <div id="field-notes-container" class="content-grid">
                                        <p class="loading-message">Loading original essays and critiques...</p>
                                        <p class="coming-soon">Field Notes (User Comments) coming soon!</p>
                                </div>
                        </section>

                        <section class="content-area">
                                <h3 class="field-section-title">Weekly Briefing (Newsletter)</h3>
                                <div id="weekly-briefing-container" class="content-grid">
                                        <p class="loading-message">Loading latest briefings...</p>
                                </div>
                        </section>
                        `;

            // Ensure RSS background image is correctly applied to its original section
            const rssSection = document.getElementById('rss-vertical-list-section');
            if (rssSection && fieldDetails.archiveBgImage) {
              rssSection.style.backgroundImage = `url('${fieldDetails.archiveBgImage}')`;
              rssSection.style.backgroundSize = 'cover';
              rssSection.style.backgroundPosition = 'center center';
              rssSection.style.backgroundRepeat = 'no-repeat';
            }

            // CALLS TO FETCH DATA
            fetchFieldRssFeeds(fieldNameParam);
            // Removed fetchDataAndDisplay for foundational-resources-container as requested.
            // It will now display the static "Coming Soon" message.

            // Updated call for Foundational Thinkers - no 'thinkerStatus' filter needed based on your sheet's snippet
            fetchDataAndDisplay(
              GOOGLE_SHEET_COMPREHENSIVE_ARCHIVE_URL,
              'foundational-thinkers-container',
              renderFoundationalThinkerCard,
              fieldNameParam,
              {},
            );

            fetchDataAndDisplay(
              GOOGLE_SHEET_COMPREHENSIVE_ARCHIVE_URL,
              'weekly-briefing-container',
              renderWeeklyBriefingCard,
              fieldNameParam,
              { medium: 'newsletter' },
            );
          } else {
            // Field Not Found HTML
            mainContentArea.innerHTML = `
                        <section class="field-hero">
                                <h2 id="field-title">Field Not Found</h2>
                                <p id="field-description">The requested field could not be found. Please check the URL or select a field from the navigation.</p>
                        </section>
                        `;
          }
        } else {
          // --- Render Fields Index Page ---
          document.title = 'Fields | Critical Fields';
          mainContentArea.innerHTML = `
                        <section class="field-hero">
                                <h2>Our Fields of Inquiry</h2>
                                <p>Explore editorialized and interdisciplinary lenses on specific critical conversations. Each field offers a focused collection of relevant archive content, literature, editor selections, and more. Our collective archive provides the resources while our editors provide the through line to understanding them.</p>
                        </section>
                        <div id="field-index-wrapper">
                                <div id="field-catalog-container">
                                        </div>
                        </div>
                        `;
          renderFieldIndexPage();
        }
      });

      // New function to render the main Fields landing page (Digital Card Catalog)
      function renderFieldIndexPage() {
        const container = document.getElementById('field-catalog-container');
        if (!container) return;

        container.innerHTML = '';

        for (const key in fieldData) {
          if (fieldData.hasOwnProperty(key)) {
            const field = fieldData[key];
            const catalogItem = document.createElement('a');
            catalogItem.href = `fields.html?name=${key}`;
            catalogItem.className = 'field-catalog-item';
            catalogItem.innerHTML = `
                            <h3 class="catalog-title">${field.title}</h3>
                            <p class="catalog-description">${field.shortBlurb}</p> <span class="cta-link">explore field &rsaquo;</span>
                            `;
            container.appendChild(catalogItem);
          }
        }
      }
    </script>
  </body>
</html>